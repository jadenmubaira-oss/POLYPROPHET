name: Redis Snapshot Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Checkout redis-backups branch
        run: |
          git fetch origin redis-backups || true
          if git show-ref --verify --quiet refs/remotes/origin/redis-backups; then
            git checkout -B redis-backups origin/redis-backups
          else
            git checkout -b redis-backups
          fi

      - name: Fetch snapshot
        env:
          REDIS_SNAPSHOT_URL: ${{ secrets.REDIS_SNAPSHOT_URL }}
          REDIS_SNAPSHOT_AUTH_USERNAME: ${{ secrets.REDIS_SNAPSHOT_AUTH_USERNAME }}
          REDIS_SNAPSHOT_AUTH_PASSWORD: ${{ secrets.REDIS_SNAPSHOT_AUTH_PASSWORD }}
          REDIS_SNAPSHOT_PASSPHRASE: ${{ secrets.REDIS_SNAPSHOT_PASSPHRASE }}
        run: |
          set -euo pipefail
          URL="${REDIS_SNAPSHOT_URL:-https://polyprophet.onrender.com/api/redis/snapshot?scope=critical}"
          USERNAME="${REDIS_SNAPSHOT_AUTH_USERNAME:-admin}"
          PASSWORD="${REDIS_SNAPSHOT_AUTH_PASSWORD:-changeme}"

          TS="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          mkdir -p redis_backups

          OUT="redis_backups/redis_snapshot_${TS}.json"
          curl -f -sS -u "${USERNAME}:${PASSWORD}" "${URL}" -o "${OUT}"
          gzip -f "${OUT}"

          if [ -n "${REDIS_SNAPSHOT_PASSPHRASE:-}" ]; then
            openssl enc -aes-256-cbc -salt -pbkdf2 -pass pass:"${REDIS_SNAPSHOT_PASSPHRASE}" -in "${OUT}.gz" -out "${OUT}.gz.enc"
            rm -f "${OUT}.gz"
          fi

      - name: Commit and push
        run: |
          set -euo pipefail
          git add redis_backups
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Redis snapshot backup $(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          git push origin redis-backups

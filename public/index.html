<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE IMMUTABLE PROPHET | Atomic System</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg: #0A0A0A;
            --surface: #1A1A1A;
            --accent: #A855F7;
            --text: #FFFFFF;
            --dim: #888888;
            --green: #22C55E;
            --red: #EF4444;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #333;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.4;
            }
        }

        .bankroll {
            font-size: 32px;
            font-weight: bold;
        }

        .asset-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }

        .asset-row:last-child {
            border-bottom: none;
        }

        .tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .tag-harvest {
            background: #3B82F6;
        }

        .tag-strike {
            background: var(--accent);
        }

        .tag-observe {
            background: #4B5563;
        }

        .progress-container {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1 style="font-size: 18px; margin: 0; color: var(--accent);">THE IMMUTABLE PROPHET</h1>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <div class="status-dot"></div>
            <div id="version" style="font-size: 11px; color: var(--dim); white-space: nowrap;"></div>
        </div>
    </div>

    <div class="card">
        <div style="color: var(--dim); font-size: 14px;">Total Bankroll (¬£)</div>
        <div class="bankroll" id="bankroll">¬£5.00</div>
        <div class="progress-container">
            <div class="progress-bar" id="goal-progress"></div>
        </div>
        <div style="font-size: 12px; color: var(--dim); margin-top: 5px;">Target: ¬£100.00</div>
    </div>

    <div class="card" id="assets-list">
        <!-- Asset rows will be injected here -->
    </div>

    <div class="card" id="golden-hour-card"
        style="display:none; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #ffd700;">
        <div style="font-size: 14px; margin-bottom: 10px; font-weight: bold; color: #ffd700;">
            üèÜ GOLDEN HOUR ACTIVE
        </div>
        <div id="golden-hour-info" style="font-size: 15px;">
            <!-- Will be populated by JavaScript -->
        </div>
        <div id="golden-hour-signal"
            style="margin-top: 12px; padding: 12px; background: rgba(0,255,136,0.15); border-radius: 8px; border: 1px solid #00ff88;">
            <div style="font-weight: bold; font-size: 16px; color: #00ff88;">CHECKING BTC...</div>
        </div>
        <div style="font-size: 11px; color: #888; margin-top: 8px;">
            93% Win Rate | 272 trades verified on 30 days data
        </div>
    </div>

    <div class="card">
        <div style="font-size: 14px; margin-bottom: 10px; font-weight: bold;">üö® Active Signals</div>
        <div id="signals-list" style="font-size: 13px;">
            Loading signals...
        </div>
    </div>

    <div class="card">
        <div style="font-size: 14px; margin-bottom: 10px;">Recent Activity</div>
        <div id="activity-list" style="font-size: 13px; color: var(--dim);">
            Syncing with server...
        </div>
    </div>

    <script>
        const socket = io();
        const goal = 100;

        // üèÜ v136: GOLDEN STRATEGY - Premium Hour Detection
        const GOLDEN_HOURS = {
            // BTC DOWN ‚Üí ETH DOWN (92.9%, 96.1%)
            2: { condition: 'DOWN', wr: '92.9%' },
            14: { condition: 'DOWN', wr: '96.1%' },
            // BTC UP ‚Üí ETH UP (93.1%, 91.5%, 91.7%)
            3: { condition: 'UP', wr: '93.1%' },
            4: { condition: 'UP', wr: '91.5%' },
            8: { condition: 'UP', wr: '91.7%' }
        };

        function updateGoldenHour(btcPrediction) {
            const now = new Date();
            const utcHour = now.getUTCHours();
            const utcMin = now.getUTCMinutes();
            const card = document.getElementById('golden-hour-card');
            const info = document.getElementById('golden-hour-info');
            const signal = document.getElementById('golden-hour-signal');

            if (!card || !info || !signal) return;

            const goldenConfig = GOLDEN_HOURS[utcHour];

            // Only show during premium hours AND first 12 mins of cycle
            const cycleMin = utcMin % 15;
            const inTradingWindow = cycleMin <= 12;

            if (goldenConfig && inTradingWindow) {
                card.style.display = 'block';

                const expectedBTC = goldenConfig.condition;
                const actualBTC = btcPrediction?.toUpperCase() || 'UNKNOWN';

                info.innerHTML = `
                    <div>Hour ${utcHour} UTC (${goldenConfig.wr} historical WR)</div>
                    <div style="font-size:12px; color:#aaa; margin-top:4px;">
                        Looking for: BTC ${expectedBTC}
                    </div>
                `;

                if (actualBTC === expectedBTC) {
                    // SIGNAL: Trade ETH in same direction
                    signal.innerHTML = `
                        <div style="font-weight: bold; font-size: 18px; color: #00ff88;">
                            üöÄ BUY ETH ${expectedBTC} NOW
                        </div>
                        <div style="font-size:12px; color:#aaa; margin-top:6px;">
                            Entry: 40-45¬¢ | Sizing: 20-30% | ${goldenConfig.wr} WR
                        </div>
                    `;
                    signal.style.background = 'rgba(0,255,136,0.25)';
                    signal.style.border = '2px solid #00ff88';
                } else if (actualBTC === 'UP' || actualBTC === 'DOWN') {
                    // Wrong direction
                    signal.innerHTML = `
                        <div style="font-weight: bold; font-size: 16px; color: #ff6b6b;">
                            ‚ùå SKIP - BTC is ${actualBTC}, need ${expectedBTC}
                        </div>
                    `;
                    signal.style.background = 'rgba(255,107,107,0.15)';
                    signal.style.border = '1px solid #ff6b6b';
                } else {
                    // Waiting for BTC direction
                    signal.innerHTML = `
                        <div style="font-weight: bold; font-size: 16px; color: #ffd700;">
                            ‚è≥ Waiting for BTC direction...
                        </div>
                        <div style="font-size:12px; color:#aaa; margin-top:4px;">
                            Need BTC ${expectedBTC} to trigger signal
                        </div>
                    `;
                    signal.style.background = 'rgba(255,215,0,0.1)';
                    signal.style.border = '1px solid #ffd700';
                }
            } else {
                card.style.display = 'none';
            }
        }


        function fmtPct01(x, digits = 0) {
            const n = Number(x);
            if (!Number.isFinite(n)) return '--';
            return (n * 100).toFixed(digits) + '%';
        }

        function fmtCents01(x, digits = 1) {
            const n = Number(x);
            if (!Number.isFinite(n)) return '--';
            return (n * 100).toFixed(digits) + '¬¢';
        }

        function renderOracleLine(asset) {
            const sig = asset?.oracleSignal;
            if (!sig || !sig.action) return 'Next: WAIT';
            const action = String(sig.action || '').toUpperCase();
            if (!action || action === 'WAIT' || action === 'HOLD' || action === 'AVOID') return 'Next: WAIT';
            const dir = sig.direction || asset.prediction || 'WAIT';
            const odds = Number.isFinite(sig.implied) ? fmtCents01(sig.implied, 1) : null;
            // üèÜ v111: Clarify pWin is calibrated win probability (historical), not model confidence
            const pWin = Number.isFinite(sig.pWin) ? fmtPct01(sig.pWin, 1) : null;
            const ev = Number.isFinite(sig.evRoi) ? (sig.evRoi >= 0 ? '+' : '') + (sig.evRoi * 100).toFixed(1) + '%' : null;
            const tLeft = Number.isFinite(sig.timeLeftSec) ? sig.timeLeftSec : null;
            const mm = tLeft !== null ? Math.floor(tLeft / 60) : null;
            const ss = tLeft !== null ? String(tLeft % 60).padStart(2, '0') : null;
            const tl = (mm !== null && ss !== null) ? `${mm}:${ss}` : null;

            // üèÜ v112: Lock diagnostics
            const cal = sig?.calibration;
            const isLocked = cal?.isLocked === true;
            const lockIcon = isLocked ? 'üîí' : '';

            let line = `Next: ${action} ${dir}`;
            if (odds) line += ` @ ${odds}`;
            if (pWin) line += ` | Cal.Win ${pWin}`;  // "Cal.Win" = Calibrated Win probability
            if (ev) line += ` | EV ${ev}`;
            if (isLocked) line += ` ${lockIcon}`;
            if (tl) line += ` | tLeft ${tl}`;
            return line;
        }

        function renderCallCounter(asset) {
            // Display last 10 BUY call outcomes: ‚úì for wins, ‚úó for losses
            const outcomes = asset?.callOutcomes || [];
            const total = asset?.callTotal || 0;
            const accuracy = asset?.callAccuracy;

            if (total === 0) {
                return '<span style="color: var(--dim);">üìä Calls: No data yet</span>';
            }

            // Build outcome string with colored checkmarks
            let outcomesHtml = '';
            outcomes.forEach((isWin, idx) => {
                if (isWin === true) {
                    outcomesHtml += '<span style="color: #22C55E;">‚úì</span>';
                } else if (isWin === false) {
                    outcomesHtml += '<span style="color: #EF4444;">‚úó</span>';
                } else {
                    outcomesHtml += '<span style="color: var(--dim);">?</span>';
                }
                if (idx < outcomes.length - 1) outcomesHtml += ' ';
            });

            // Calculate wins from outcomes
            const wins = outcomes.filter(o => o === true).length;
            const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '--';

            // Color the accuracy based on win rate
            let accColor = 'var(--dim)';
            if (Number(pct) >= 80) accColor = '#22C55E';  // Green for 80%+
            else if (Number(pct) >= 60) accColor = '#ffd700';  // Gold for 60-79%
            else if (Number(pct) < 60) accColor = '#EF4444';  // Red for <60%

            return `<span style="color: var(--dim);">üìä Calls:</span> ${outcomesHtml} <span style="color: ${accColor}; font-weight: bold;">(${wins}/${total} = ${pct}%)</span>`;
        }

        async function loadVersion() {
            const el = document.getElementById('version');
            if (!el) return;
            try {
                const res = await fetch('/api/version', { cache: 'no-store' });
                const v = await res.json();
                const commit = v.gitCommit ? String(v.gitCommit).slice(0, 7) : 'unknown';
                el.innerText = `v${v.configVersion || '?'} ‚Ä¢ ${commit}`;
            } catch (e) {
                el.innerText = 'version: unavailable';
            }
        }

        socket.on('connect', () => {
            console.log('‚úÖ Connected to server');
            document.getElementById('activity-list').innerText = 'Connected to server...';
            loadVersion();
        });

        socket.on('disconnect', () => {
            console.log('‚ùå Disconnected from server');
            document.getElementById('activity-list').innerText = 'Disconnected from server...';
        });

        socket.on('omega_update', (data) => {
            // Update Bankroll
            const bankroll = data.bankroll || 5.00;
            document.getElementById('bankroll').innerText = `¬£${bankroll.toFixed(2)}`;
            const progress = Math.min((bankroll / goal) * 100, 100);
            document.getElementById('goal-progress').style.width = `${progress}%`;

            // üèÜ v136: Update Golden Hour signal with BTC direction
            const btcAsset = data.assets?.BTC;
            const btcPrediction = btcAsset?.prediction;
            updateGoldenHour(btcPrediction);

            // Update Asset Rows
            const list = document.getElementById('assets-list');
            if (!list) return;

            list.innerHTML = '<div style="font-size: 14px; margin-bottom: 10px; font-weight: bold;">Assets</div>';

            if (data.assets && Object.keys(data.assets).length > 0) {
                Object.entries(data.assets).forEach(([name, asset]) => {
                    const row = document.createElement('div');
                    row.className = 'asset-row';
                    const label = asset.marketUrl
                        ? `<a href="${asset.marketUrl}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;">${name}</a>`
                        : name;
                    const sig = asset.oracleSignal;
                    const hasSignal = sig && sig.action && ['BUY', 'PREPARE'].includes(String(sig.action).toUpperCase());
                    const signalBadge = hasSignal
                        ? `<span style="background:${sig.action === 'BUY' ? '#10b981' : '#ffd700'};color:${sig.action === 'BUY' ? '#000' : '#000'};padding:2px 8px;border-radius:4px;font-size:11px;font-weight:bold;margin-left:8px;">
                            ${sig.action} ${sig.direction || asset.prediction || 'WAIT'}
                          </span>`
                        : '';
                    const convictionBadge = sig && sig.tier === 'CONVICTION'
                        ? `<span style="background:linear-gradient(90deg,#ff0066,#cc0055);color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:bold;margin-left:8px;">üíé CONVICTION</span>`
                        : '';

                    row.innerHTML = `
                        <div>
                            <div style="display:flex;align-items:center;gap:4px;">
                                <div style="font-weight: bold;">${label}</div>
                                ${signalBadge}
                                ${convictionBadge}
                            </div>
                            <div style="font-size: 12px; color: var(--dim);">
                                ${asset.prediction || 'WAIT'} | ${asset.tier || 'NONE'} | Conf: ${fmtPct01(asset.confidence, 0)}
                            </div>
                            <div style="font-size: 12px; color: var(--dim); margin-top: 2px;">
                                ${renderOracleLine(asset)}
                            </div>
                            <div style="font-size: 11px; margin-top: 4px;">
                                ${renderCallCounter(asset)}
                            </div>
                        </div>
                        <div class="tag tag-${asset.state.toLowerCase()}">${asset.state}</div>
                    `;
                    list.appendChild(row);
                });
            } else {
                list.innerHTML += '<div style="color: var(--dim); font-size: 13px;">No asset data available</div>';
            }

            // Update Signals Section
            const signalsList = document.getElementById('signals-list');
            if (signalsList) {
                signalsList.innerHTML = '';
                let hasSignals = false;
                if (data.assets && Object.keys(data.assets).length > 0) {
                    Object.entries(data.assets).forEach(([name, asset]) => {
                        const sig = asset.oracleSignal;
                        if (sig && sig.action && ['BUY', 'PREPARE'].includes(String(sig.action).toUpperCase())) {
                            hasSignals = true;
                            const action = String(sig.action).toUpperCase();
                            const dir = sig.direction || asset.prediction || 'WAIT';
                            const odds = Number.isFinite(sig.implied) ? fmtCents01(sig.implied, 1) : '--';
                            const pWin = Number.isFinite(sig.pWin) ? fmtPct01(sig.pWin, 1) : '--';
                            const tier = sig.tier || 'NONE';
                            const isLocked = sig.calibration?.isLocked === true;

                            const signalDiv = document.createElement('div');
                            signalDiv.style.cssText = 'padding:10px;margin-bottom:8px;border-radius:8px;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);';
                            signalDiv.innerHTML = `
                                <div style="font-weight:bold;color:#00ff88;">${name}: ${action} ${dir}</div>
                                <div style="font-size:11px;color:#aaa;margin-top:4px;">
                                    @ ${odds} | pWin: ${pWin} | Tier: ${tier} ${isLocked ? 'üîí' : ''}
                                </div>
                            `;
                            signalsList.appendChild(signalDiv);
                        }
                    });
                }
                if (!hasSignals) {
                    signalsList.innerHTML = '<div style="color: var(--dim);">No active signals</div>';
                }
            }

            // Update Activity
            const activity = document.getElementById('activity-list');
            if (!activity) return;

            activity.innerHTML = '';

            if (data.assets && Object.keys(data.assets).length > 0) {
                let hasActivity = false;
                Object.entries(data.assets).forEach(([name, asset]) => {
                    const sig = asset.oracleSignal;
                    if (sig && sig.action && ['PREPARE', 'BUY', 'SELL'].includes(String(sig.action).toUpperCase())) {
                        hasActivity = true;
                        const div = document.createElement('div');
                        div.style.marginBottom = '5px';
                        const action = String(sig.action).toUpperCase();
                        const dir = sig.direction || asset.prediction || 'WAIT';
                        const odds = Number.isFinite(sig.implied) ? fmtCents01(sig.implied, 1) : '--';
                        div.innerHTML = `<strong>${name}</strong>: ${action} ${dir} @ ${odds}`;
                        activity.appendChild(div);
                    }
                });

                if (!hasActivity) {
                    activity.innerHTML = '<div style="color: var(--dim);">Waiting for trading signals...</div>';
                }
            } else {
                activity.innerHTML = '<div style="color: var(--dim);">Syncing with server...</div>';
            }

            // Show P/L if available
            if (data.todayPnL !== undefined) {
                const pnlDiv = document.createElement('div');
                pnlDiv.style.marginTop = '10px';
                pnlDiv.style.paddingTop = '10px';
                pnlDiv.style.borderTop = '1px solid #333';
                pnlDiv.style.color = data.todayPnL >= 0 ? 'var(--green)' : 'var(--red)';
                pnlDiv.innerHTML = `<strong>Today's P/L:</strong> ¬£${data.todayPnL.toFixed(2)}`;
                activity.appendChild(pnlDiv);
            }
        });
    </script>
</body>

</html>
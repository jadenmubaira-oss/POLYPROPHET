<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE IMMUTABLE PROPHET | Atomic System</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg: #0A0A0A;
            --surface: #1A1A1A;
            --accent: #A855F7;
            --text: #FFFFFF;
            --dim: #888888;
            --green: #22C55E;
            --red: #EF4444;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #333;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.4;
            }
        }

        .bankroll {
            font-size: 32px;
            font-weight: bold;
        }

        .asset-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }

        .asset-row:last-child {
            border-bottom: none;
        }

        .tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .tag-harvest {
            background: #3B82F6;
        }

        .tag-strike {
            background: var(--accent);
        }

        .tag-observe {
            background: #4B5563;
        }

        .progress-container {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1 style="font-size: 18px; margin: 0; color: var(--accent);">THE IMMUTABLE PROPHET</h1>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <div class="status-dot"></div>
            <div id="version" style="font-size: 11px; color: var(--dim); white-space: nowrap;"></div>
            <a href="/tools.html" style="font-size: 11px; color: var(--accent); text-decoration: none;">üõ†Ô∏è Tools</a>
        </div>
    </div>

    <div class="card">
        <div style="color: var(--dim); font-size: 14px;">Total Bankroll (¬£)</div>
        <div class="bankroll" id="bankroll">¬£5.00</div>
        <div class="progress-container">
            <div class="progress-bar" id="goal-progress"></div>
        </div>
        <div style="font-size: 12px; color: var(--dim); margin-top: 5px;">Target: ¬£100.00</div>
    </div>

    <div class="card" id="assets-list">
        <!-- Asset rows will be injected here -->
    </div>

    <div class="card">
        <div style="font-size: 14px; margin-bottom: 10px;">Recent Activity</div>
        <div id="activity-list" style="font-size: 13px; color: var(--dim);">
            Syncing with server...
        </div>
    </div>

    <script>
        const socket = io();
        const goal = 100;

        function fmtPct01(x, digits = 0) {
            const n = Number(x);
            if (!Number.isFinite(n)) return '--';
            return (n * 100).toFixed(digits) + '%';
        }

        function fmtCents01(x, digits = 1) {
            const n = Number(x);
            if (!Number.isFinite(n)) return '--';
            return (n * 100).toFixed(digits) + '¬¢';
        }

        function renderOracleLine(asset) {
            const sig = asset?.oracleSignal;
            if (!sig || !sig.action) return 'Next: WAIT';
            const action = String(sig.action || '').toUpperCase();
            if (!action || action === 'WAIT' || action === 'HOLD' || action === 'AVOID') return 'Next: WAIT';
            const dir = sig.direction || asset.prediction || 'WAIT';
            const odds = Number.isFinite(sig.implied) ? fmtCents01(sig.implied, 1) : null;
            const pWin = Number.isFinite(sig.pWin) ? fmtPct01(sig.pWin, 1) : null;
            const ev = Number.isFinite(sig.evRoi) ? (sig.evRoi >= 0 ? '+' : '') + (sig.evRoi * 100).toFixed(1) + '%' : null;
            const tLeft = Number.isFinite(sig.timeLeftSec) ? sig.timeLeftSec : null;
            const mm = tLeft !== null ? Math.floor(tLeft / 60) : null;
            const ss = tLeft !== null ? String(tLeft % 60).padStart(2, '0') : null;
            const tl = (mm !== null && ss !== null) ? `${mm}:${ss}` : null;

            let line = `Next: ${action} ${dir}`;
            if (odds) line += ` @ ${odds}`;
            if (pWin) line += ` | pWin ${pWin}`;
            if (ev) line += ` | EV ${ev}`;
            if (tl) line += ` | tLeft ${tl}`;
            return line;
        }

        async function loadVersion() {
            const el = document.getElementById('version');
            if (!el) return;
            try {
                const res = await fetch('/api/version', { cache: 'no-store' });
                const v = await res.json();
                const commit = v.gitCommit ? String(v.gitCommit).slice(0, 7) : 'unknown';
                el.innerText = `v${v.configVersion || '?'} ‚Ä¢ ${commit}`;
            } catch (e) {
                el.innerText = 'version: unavailable';
            }
        }

        socket.on('connect', () => {
            console.log('‚úÖ Connected to server');
            document.getElementById('activity-list').innerText = 'Connected to server...';
            loadVersion();
        });

        socket.on('disconnect', () => {
            console.log('‚ùå Disconnected from server');
            document.getElementById('activity-list').innerText = 'Disconnected from server...';
        });

        socket.on('omega_update', (data) => {
            // Update Bankroll
            const bankroll = data.bankroll || 5.00;
            document.getElementById('bankroll').innerText = `¬£${bankroll.toFixed(2)}`;
            const progress = Math.min((bankroll / goal) * 100, 100);
            document.getElementById('goal-progress').style.width = `${progress}%`;

            // Update Asset Rows
            const list = document.getElementById('assets-list');
            if (!list) return;
            
            list.innerHTML = '<div style="font-size: 14px; margin-bottom: 10px; font-weight: bold;">Assets</div>';

            if (data.assets && Object.keys(data.assets).length > 0) {
                Object.entries(data.assets).forEach(([name, asset]) => {
                    const row = document.createElement('div');
                    row.className = 'asset-row';
                    const label = asset.marketUrl
                        ? `<a href="${asset.marketUrl}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;">${name}</a>`
                        : name;
                    row.innerHTML = `
                        <div>
                            <div style="font-weight: bold;">${label}</div>
                            <div style="font-size: 12px; color: var(--dim);">
                                ${asset.prediction || 'WAIT'} | ${asset.tier || 'NONE'} | ${fmtPct01(asset.confidence, 0)}
                            </div>
                            <div style="font-size: 12px; color: var(--dim); margin-top: 2px;">
                                ${renderOracleLine(asset)}
                            </div>
                        </div>
                        <div class="tag tag-${asset.state.toLowerCase()}">${asset.state}</div>
                    `;
                    list.appendChild(row);
                });
            } else {
                list.innerHTML += '<div style="color: var(--dim); font-size: 13px;">No asset data available</div>';
            }

            // Update Activity
            const activity = document.getElementById('activity-list');
            if (!activity) return;
            
            activity.innerHTML = '';
            
            if (data.assets && Object.keys(data.assets).length > 0) {
                let hasActivity = false;
                Object.entries(data.assets).forEach(([name, asset]) => {
                    const sig = asset.oracleSignal;
                    if (sig && sig.action && ['PREPARE','BUY','SELL'].includes(String(sig.action).toUpperCase())) {
                        hasActivity = true;
                        const div = document.createElement('div');
                        div.style.marginBottom = '5px';
                        const action = String(sig.action).toUpperCase();
                        const dir = sig.direction || asset.prediction || 'WAIT';
                        const odds = Number.isFinite(sig.implied) ? fmtCents01(sig.implied, 1) : '--';
                        div.innerHTML = `<strong>${name}</strong>: ${action} ${dir} @ ${odds}`;
                        activity.appendChild(div);
                    }
                });
                
                if (!hasActivity) {
                    activity.innerHTML = '<div style="color: var(--dim);">Waiting for trading signals...</div>';
                }
            } else {
                activity.innerHTML = '<div style="color: var(--dim);">Syncing with server...</div>';
            }
            
            // Show P/L if available
            if (data.todayPnL !== undefined) {
                const pnlDiv = document.createElement('div');
                pnlDiv.style.marginTop = '10px';
                pnlDiv.style.paddingTop = '10px';
                pnlDiv.style.borderTop = '1px solid #333';
                pnlDiv.style.color = data.todayPnL >= 0 ? 'var(--green)' : 'var(--red)';
                pnlDiv.innerHTML = `<strong>Today's P/L:</strong> ¬£${data.todayPnL.toFixed(2)}`;
                activity.appendChild(pnlDiv);
            }
        });
    </script>
</body>

</html>
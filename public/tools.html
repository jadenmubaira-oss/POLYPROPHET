<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è Tools - POLYPROPHET</title>
    <!-- POLYPROPHET_TOOLS_UI_MARKER_v86 -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #0a0f1c 0%, #1a1f3c 50%, #0d1225 100%); 
            color: #e0e8ff; 
            min-height: 100vh; 
        }
        .nav { 
            background: rgba(0,0,0,0.6); 
            padding: 12px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid rgba(100,150,255,0.2); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            backdrop-filter: blur(10px); 
        }
        .nav-brand { font-size: 1.4em; font-weight: bold; color: #ffd700; }
        .nav-links { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-btn { 
            background: rgba(100,150,255,0.2); 
            border: 1px solid rgba(100,150,255,0.3); 
            color: #88ccff; 
            padding: 8px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9em; 
            transition: all 0.3s; 
            text-decoration: none;
        }
        .nav-btn:hover { background: rgba(100,150,255,0.4); transform: scale(1.05); }
        
        .main-container { padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        .section-title { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: #ffd700; 
            margin: 25px 0 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        
        .panel { 
            background: linear-gradient(145deg, rgba(20,30,60,0.9), rgba(10,20,40,0.95)); 
            border-radius: 14px; 
            padding: 20px; 
            margin-bottom: 20px; 
            border: 2px solid rgba(100,150,255,0.15); 
        }
        .panel:hover { border-color: rgba(100,150,255,0.3); }
        
        .panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .panel-title { font-size: 1.2em; font-weight: bold; color: #00ff88; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { 
            display: block; 
            margin-bottom: 6px; 
            color: #88ccff; 
            font-weight: bold; 
            font-size: 0.85em; 
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid rgba(100,150,255,0.2); 
            border-radius: 8px; 
            background: rgba(0,0,0,0.4); 
            color: #fff; 
            font-size: 0.95em; 
        }
        .form-group input:focus { border-color: #4fc3f7; outline: none; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        
        .btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            font-size: 0.95em; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        .btn-primary { background: linear-gradient(90deg, #4fc3f7, #2196f3); color: #fff; }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(33,150,243,0.4); }
        .btn-success { background: linear-gradient(90deg, #00ff88, #00cc66); color: #000; }
        .btn-success:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,255,136,0.4); }
        .btn-warning { background: linear-gradient(90deg, #ffd700, #ff9900); color: #000; }
        .btn-warning:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(255,215,0,0.4); }
        .btn-danger { background: linear-gradient(90deg, #ff4466, #cc2244); color: #fff; }
        .btn-danger:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(255,68,102,0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        
        .result-box {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(100,150,255,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .result-box.success { border-color: #00ff88; }
        .result-box.error { border-color: #ff4466; }
        .result-box.loading { border-color: #ffd700; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8em;
        }
        .status-badge.pass { background: linear-gradient(90deg, #00ff88, #00cc66); color: #000; }
        .status-badge.fail { background: linear-gradient(90deg, #ff4466, #cc2244); color: #fff; }
        .status-badge.running { background: linear-gradient(90deg, #ffd700, #ff9900); color: #000; animation: pulse 1s infinite; }
        
        .check-item {
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .check-item.pass { border-left: 3px solid #00ff88; }
        .check-item.fail { border-left: 3px solid #ff4466; }
        
        .winner-card {
            background: linear-gradient(145deg, rgba(0,255,136,0.1), rgba(0,200,100,0.05));
            border: 2px solid #00ff88;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 0 20px rgba(0,255,136,0.2);
        }
        .winner-title { color: #00ff88; font-size: 1.2em; margin-bottom: 10px; }
        .winner-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 15px 0; }
        .winner-stat { text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .winner-stat-value { font-size: 1.4em; font-weight: bold; color: #ffd700; }
        .winner-stat-label { font-size: 0.75em; color: #888; text-transform: uppercase; }
        
        .api-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 15px; }
        .api-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(100,150,255,0.2);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .api-card:hover { border-color: #4fc3f7; transform: translateY(-2px); }
        .api-card.dangerous { border-color: rgba(255,68,102,0.4); }
        .api-card.dangerous:hover { border-color: #ff4466; }
        .api-card-title { font-weight: bold; color: #88ccff; margin-bottom: 5px; }
        .api-card-desc { font-size: 0.8em; color: #888; }
        .api-card-method { 
            display: inline-block; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 0.7em; 
            font-weight: bold;
            margin-right: 8px;
        }
        .api-card-method.get { background: #00ff88; color: #000; }
        .api-card-method.post { background: #4fc3f7; color: #000; }
        
        .safety-warning {
            background: rgba(255,68,102,0.1);
            border: 1px solid rgba(255,68,102,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        .safety-warning.visible { display: block; }
        
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        @media (max-width: 768px) {
            .nav { flex-direction: column; gap: 10px; }
            .form-grid { grid-template-columns: 1fr; }
            .winner-stats { grid-template-columns: repeat(2, 1fr); }
        }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid rgba(100,150,255,0.2); padding-bottom: 10px; }
        .tab { 
            padding: 10px 20px; 
            background: rgba(0,0,0,0.3); 
            border: 1px solid rgba(100,150,255,0.2);
            border-radius: 8px 8px 0 0;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab:hover { background: rgba(100,150,255,0.2); color: #fff; }
        .tab.active { background: rgba(100,150,255,0.3); border-color: #4fc3f7; color: #4fc3f7; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-brand">üõ†Ô∏è POLYPROPHET TOOLS</div>
        <div class="nav-links">
            <a href="/" class="nav-btn">üìä Dashboard</a>
            <a href="/settings" class="nav-btn">‚öôÔ∏è Settings</a>
            <a href="/index.html" class="nav-btn">üì± Simple UI</a>
            <a href="/mobile.html" class="nav-btn">üì≤ Mobile</a>
        </div>
    </nav>
    
    <div class="main-container">
        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('vault', event)">üè¶ Monte Carlo</button>
            <button class="tab" onclick="switchTab('polymarket', event)">üìà Polymarket Backtest</button>
            <button class="tab" onclick="switchTab('audit', event)">‚úÖ Goal Audit</button>
            <button class="tab" onclick="switchTab('explorer', event)">üîå API Explorer</button>
        </div>
        
        <!-- VAULT OPTIMIZER TAB -->
        <div id="vault-tab" class="tab-content active">
            <h2 class="section-title">üè¶ Vault Trigger Optimization</h2>
            <p style="color:#888;margin-bottom:20px;">
                Optimize the vault trigger balance ($6.10‚Äì$15.00) to maximize P($100 by day 7) and P($1000 by day 30).
            </p>
            
            <!-- Vault Projection Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üìà Vault Projection</span>
                    <span id="projection-status" class="status-badge" style="display:none;"></span>
                </div>
                <p style="color:#666;font-size:0.85em;margin-bottom:15px;">Run Monte Carlo simulation for a specific vault trigger balance.</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Vault Trigger Balance ($)</label>
                        <input type="number" id="proj-trigger" value="11" min="6.1" max="15" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Starting Balance ($)</label>
                        <input type="number" id="proj-start" value="5" min="1" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Simulations</label>
                        <input type="number" id="proj-sims" value="1000" min="100" max="10000" step="100">
                    </div>
                    <div class="form-group">
                        <label>Seed (optional)</label>
                        <input type="number" id="proj-seed" placeholder="Leave empty for random">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="runProjection()" id="proj-btn">üìà Run Projection</button>
                
                <div id="proj-result" class="result-box" style="display:none;"></div>
            </div>
            
            <!-- Vault Optimizer Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üîç Vault Optimizer</span>
                    <span id="optimizer-status" class="status-badge" style="display:none;"></span>
                </div>
                <p style="color:#666;font-size:0.85em;margin-bottom:15px;">Sweep vault trigger range to find the optimal value for your goals.</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Range Start ($)</label>
                        <input type="number" id="opt-min" value="6.1" min="5" max="15" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Range End ($)</label>
                        <input type="number" id="opt-max" value="15" min="6" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Step Size ($)</label>
                        <input type="number" id="opt-step" value="0.1" min="0.05" max="1" step="0.05">
                    </div>
                    <div class="form-group">
                        <label>Sims Per Candidate</label>
                        <input type="number" id="opt-sims" value="500" min="100" max="5000" step="100">
                    </div>
                    <div class="form-group">
                        <label>Starting Balance ($)</label>
                        <input type="number" id="opt-start" value="5" min="1" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Seed (optional)</label>
                        <input type="number" id="opt-seed" placeholder="Leave empty for random">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="runOptimizer()" id="opt-btn">üîç Find Optimal Trigger</button>
                
                <!-- Winner Card -->
                <div id="winner-card" class="winner-card" style="display:none;">
                    <div class="winner-title">üèÜ OPTIMAL VAULT TRIGGER FOUND</div>
                    <div class="winner-stats">
                        <div class="winner-stat">
                            <div class="winner-stat-value" id="winner-trigger">--</div>
                            <div class="winner-stat-label">Trigger ($)</div>
                        </div>
                        <div class="winner-stat">
                            <div class="winner-stat-value" id="winner-p100">--</div>
                            <div class="winner-stat-label">P($100@7d)</div>
                        </div>
                        <div class="winner-stat">
                            <div class="winner-stat-value" id="winner-p1000">--</div>
                            <div class="winner-stat-label">P($1000@30d)</div>
                        </div>
                        <div class="winner-stat">
                            <div class="winner-stat-value" id="winner-ruin">--</div>
                            <div class="winner-stat-label">Ruin Risk</div>
                        </div>
                    </div>
                    <button class="btn btn-warning" onclick="applyWinner()" id="apply-winner-btn">
                        üëë APPLY WINNER TO CONFIG (requires confirmation)
                    </button>
                    <div id="apply-result" style="margin-top:10px;font-size:0.9em;"></div>
                </div>
                
                <div id="opt-result" class="result-box" style="display:none;"></div>
            </div>
        </div>
        
        <!-- POLYMARKET BACKTEST OPTIMIZER TAB (v84) -->
        <div id="polymarket-tab" class="tab-content">
            <h2 class="section-title">üìà Polymarket Backtest Optimizer</h2>
            <p style="color:#888;margin-bottom:20px;">
                <strong style="color:#ffd700;">üèÜ Ground Truth Optimizer</strong> ‚Äî Uses real Polymarket outcomes (via Gamma API) to find the optimal vaultTriggerBalance.
                This is the AUTHORITATIVE source for P($100 by day 7). To evaluate P($1000 by day 30), set <strong>Window Hours = 720</strong> (otherwise the 30-day metric will show <code>N/A</code>).
            </p>
            
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üî¨ Polymarket-Native Optimizer</span>
                    <span id="pm-optimizer-status" class="status-badge" style="display:none;"></span>
                </div>
                <p style="color:#666;font-size:0.85em;margin-bottom:15px;">
                    Sweep vault trigger values using actual Polymarket backtest data across multiple non-cherry-picked windows.
                    Results are ranked by your objective ordering: maximize P($100@7d), then P($1000@30d), with ruin and drawdown as tie-breakers.
                </p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Range Start ($)</label>
                        <input type="number" id="pm-min" value="6.1" min="5" max="15" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Range End ($)</label>
                        <input type="number" id="pm-max" value="15" min="6" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Step Size ($)</label>
                        <input type="number" id="pm-step" value="1" min="0.5" max="2" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Window Hours (168=7d, 720=30d)</label>
                        <input type="number" id="pm-hours" value="168" min="24" max="720" step="24">
                    </div>
                    <div class="form-group">
                        <label>Window Offsets (comma-sep)</label>
                        <input type="text" id="pm-offsets" value="0,24,48,72" placeholder="e.g. 0,24,48,72">
                    </div>
                    <div class="form-group">
                        <label>Starting Balance ($)</label>
                        <input type="number" id="pm-start" value="5" min="1" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Tier</label>
                        <select id="pm-tier">
                            <option value="CONVICTION" selected>CONVICTION</option>
                            <option value="STRONG">STRONG</option>
                            <option value="MODERATE">MODERATE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kelly Max</label>
                        <input type="number" id="pm-kelly" value="0.17" min="0.1" max="0.5" step="0.01">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="runPolymarketOptimizer()" id="pm-opt-btn">üìà Run Polymarket Optimizer</button>
                
                <!-- PM Winner Card -->
                <div id="pm-winner-card" class="winner-card" style="display:none;">
                    <div class="winner-title">üèÜ OPTIMAL VAULT TRIGGER (POLYMARKET GROUND TRUTH)</div>
                    <div class="winner-stats">
                        <div class="winner-stat">
                            <div class="winner-stat-value" id="pm-winner-trigger">--</div>
                            <div class="winner-stat-label">Trigger ($)</div>
                        </div>
                        <div class="winner-stat">
                            <div class="winner-stat-value" id="pm-winner-p100">--</div>
                            <div class="winner-stat-label">P($100@7d)</div>
                        </div>
                        <div class="winner-stat">
                            <div class="winner-stat-value" id="pm-winner-p1000">--</div>
                            <div class="winner-stat-label">P($1000@30d)</div>
                        </div>
                        <div class="winner-stat">
                            <div class="winner-stat-value" id="pm-winner-ruin">--</div>
                            <div class="winner-stat-label">Ruin Risk</div>
                        </div>
                    </div>
                    <button class="btn btn-warning" onclick="applyPolymarketWinner()" id="pm-apply-btn">
                        üëë APPLY WINNER TO CONFIG (requires confirmation)
                    </button>
                    <div id="pm-apply-result" style="margin-top:10px;font-size:0.9em;"></div>
                </div>
                
                <div id="pm-opt-result" class="result-box" style="display:none;"></div>
            </div>
        </div>
        
        <!-- GOAL AUDIT TAB -->
        <div id="audit-tab" class="tab-content">
            <h2 class="section-title">‚úÖ Goal Audit / Perfection Check</h2>
            <p style="color:#888;margin-bottom:20px;">
                Verify that the vault system is correctly wired and meets all AI-handoff requirements.
            </p>
            
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üî¨ System Verification</span>
                    <span id="audit-status" class="status-badge" style="display:none;"></span>
                </div>
                
                <button class="btn btn-success" onclick="runPerfectionCheck()" id="audit-btn">‚úÖ Run Perfection Check</button>
                
                <!-- Audit Summary -->
                <div id="audit-summary" style="display:none;margin-top:20px;">
                    <div style="display:flex;gap:20px;margin-bottom:15px;">
                        <div style="text-align:center;padding:15px;background:rgba(0,255,136,0.1);border-radius:8px;flex:1;">
                            <div id="audit-passed" style="font-size:2em;font-weight:bold;color:#00ff88;">0</div>
                            <div style="font-size:0.8em;color:#888;">PASSED</div>
                        </div>
                        <div style="text-align:center;padding:15px;background:rgba(255,68,102,0.1);border-radius:8px;flex:1;">
                            <div id="audit-failed" style="font-size:2em;font-weight:bold;color:#ff4466;">0</div>
                            <div style="font-size:0.8em;color:#888;">FAILED</div>
                        </div>
                    </div>
                    
                    <div id="audit-checks"></div>
                </div>
                
                <div id="audit-result" class="result-box" style="display:none;"></div>
            </div>
        </div>
        
        <!-- API EXPLORER TAB -->
        <div id="explorer-tab" class="tab-content">
            <h2 class="section-title">üîå API Explorer</h2>
            <p style="color:#888;margin-bottom:20px;">
                Explore and test all available API endpoints.
            </p>
            
            <!-- Safety Warning -->
            <div id="safety-warning" class="safety-warning">
                <strong style="color:#ff4466;">‚ö†Ô∏è DANGEROUS ENDPOINT</strong>
                <p style="color:#aaa;margin-top:8px;">This endpoint can modify system state or execute trades. Proceed with caution.</p>
                <label style="display:flex;align-items:center;gap:8px;margin-top:10px;cursor:pointer;">
                    <input type="checkbox" id="safety-confirm">
                    <span style="color:#ff9966;">I understand the risks and want to proceed</span>
                </label>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üì° Make API Request</span>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 2fr;">
                    <div class="form-group">
                        <label>Method</label>
                        <select id="api-method" onchange="onMethodChange()">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Endpoint</label>
                        <select id="api-endpoint" onchange="onEndpointChange()">
                            <optgroup label="üè¶ Vault (Safe)">
                                <option value="/api/vault-projection">vault-projection</option>
                                <option value="/api/vault-optimize">vault-optimize (Monte Carlo)</option>
                                <option value="/api/vault-optimize-polymarket">vault-optimize-polymarket (Ground Truth)</option>
                                <option value="/api/perfection-check">perfection-check</option>
                            </optgroup>
                            <optgroup label="üìä Information (Safe)">
                                <option value="/api/version">version</option>
                                <option value="/api/state">state</option>
                                <option value="/api/settings">settings</option>
                                <option value="/api/risk-controls">risk-controls</option>
                                <option value="/api/health">health</option>
                                <option value="/api/debug-export">debug-export</option>
                            </optgroup>
                            <optgroup label="üìà Backtests (Safe)">
                                <option value="/api/backtest-dataset">backtest-dataset</option>
                                <option value="/api/backtest-polymarket">backtest-polymarket</option>
                            </optgroup>
                            <optgroup label="‚ö†Ô∏è Dangerous (Modifies State)">
                                <option value="/api/settings" data-method="POST" data-dangerous="true">settings [POST]</option>
                                <option value="/api/manual-buy" data-method="POST" data-dangerous="true">manual-buy [POST]</option>
                                <option value="/api/manual-sell" data-method="POST" data-dangerous="true">manual-sell [POST]</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Query Parameters (JSON object, e.g. {"seed": 12345})</label>
                    <input type="text" id="api-params" placeholder='{"vaultTriggerBalance": 11, "sims": 500}'>
                </div>
                
                <div class="form-group" id="body-group" style="display:none;">
                    <label>Request Body (JSON)</label>
                    <textarea id="api-body" rows="4" style="width:100%;padding:10px;border:2px solid rgba(100,150,255,0.2);border-radius:8px;background:rgba(0,0,0,0.4);color:#fff;font-family:monospace;resize:vertical;">{}</textarea>
                </div>
                
                <button class="btn btn-primary" onclick="makeApiRequest()" id="api-btn">üöÄ Send Request</button>
                
                <div id="api-result" class="result-box" style="display:none;"></div>
            </div>
            
            <!-- Quick Links -->
            <h3 style="color:#88ccff;margin:20px 0 15px;">üìö Quick Reference</h3>
            <div class="api-grid">
                <div class="api-card" onclick="quickCall('/api/version')">
                    <span class="api-card-method get">GET</span>
                    <span class="api-card-title">/api/version</span>
                    <div class="api-card-desc">Get server version, config version, git commit</div>
                </div>
                <div class="api-card" onclick="quickCall('/api/risk-controls')">
                    <span class="api-card-method get">GET</span>
                    <span class="api-card-title">/api/risk-controls</span>
                    <div class="api-card-desc">Current risk state, vault thresholds, dynamic profile</div>
                </div>
                <div class="api-card" onclick="quickCall('/api/perfection-check')">
                    <span class="api-card-method get">GET</span>
                    <span class="api-card-title">/api/perfection-check</span>
                    <div class="api-card-desc">AI verification of vault system correctness</div>
                </div>
                <div class="api-card" onclick="quickCall('/api/vault-projection?vaultTriggerBalance=11&sims=500')">
                    <span class="api-card-method get">GET</span>
                    <span class="api-card-title">/api/vault-projection</span>
                    <div class="api-card-desc">Monte Carlo projection for vault trigger</div>
                </div>
                <div class="api-card" onclick="quickCall('/api/vault-optimize?min=6.1&max=15&step=0.5&sims=200')">
                    <span class="api-card-method get">GET</span>
                    <span class="api-card-title">/api/vault-optimize</span>
                    <div class="api-card-desc">Monte Carlo optimizer for vault trigger</div>
                </div>
                <div class="api-card" onclick="quickCall('/api/vault-optimize-polymarket?min=6.1&max=15&step=1&hours=168&offsets=0,24,48,72')">
                    <span class="api-card-method get">GET</span>
                    <span class="api-card-title">/api/vault-optimize-polymarket</span>
                    <div class="api-card-desc">üèÜ Ground truth optimizer using real Polymarket data</div>
                </div>
                <div class="api-card" onclick="quickCall('/api/health')">
                    <span class="api-card-method get">GET</span>
                    <span class="api-card-title">/api/health</span>
                    <div class="api-card-desc">Server health status</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Tab switching - v84: Fixed to use closest() for reliable tab button targeting
        function switchTab(tabName, evt) {
            // Use the event passed as argument, or fallback to global event
            const e = evt || window.event;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // v84: Use closest() to find the tab button even if click was on child element
            const tabBtn = e && e.target ? e.target.closest('.tab') : null;
            if (tabBtn) tabBtn.classList.add('active');
            
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        // Current winner data for apply
        let currentWinner = null;
        let currentPolymarketWinner = null;  // üèÜ v84: Separate winner for Polymarket optimizer
        
        // üèÜ v83: Get apiKey from URL if present (for query-param auth support)
        function getApiKeyParam() {
            const params = new URLSearchParams(window.location.search);
            const apiKey = params.get('apiKey');
            return apiKey ? `&apiKey=${encodeURIComponent(apiKey)}` : '';
        }
        
        // ==================== VAULT PROJECTION ====================
        async function runProjection() {
            const btn = document.getElementById('proj-btn');
            const status = document.getElementById('projection-status');
            const result = document.getElementById('proj-result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Running...';
            status.textContent = 'RUNNING';
            status.className = 'status-badge running';
            status.style.display = 'inline-block';
            result.style.display = 'none';
            
            try {
                const trigger = document.getElementById('proj-trigger').value;
                const start = document.getElementById('proj-start').value;
                const sims = document.getElementById('proj-sims').value;
                const seed = document.getElementById('proj-seed').value;
                
                let url = `/api/vault-projection?vaultTriggerBalance=${trigger}&balance=${start}&sims=${sims}`;
                if (seed) url += `&seed=${seed}`;
                url += getApiKeyParam();
                
                const res = await fetch(url);
                const data = await res.json();
                
                status.textContent = 'COMPLETE';
                status.className = 'status-badge pass';
                result.className = 'result-box success';
                result.style.display = 'block';
                result.textContent = JSON.stringify(data, null, 2);
                
            } catch (e) {
                status.textContent = 'ERROR';
                status.className = 'status-badge fail';
                result.className = 'result-box error';
                result.style.display = 'block';
                result.textContent = 'Error: ' + e.message;
            }
            
            btn.disabled = false;
            btn.textContent = 'üìà Run Projection';
        }
        
        // ==================== VAULT OPTIMIZER ====================
        async function runOptimizer() {
            const btn = document.getElementById('opt-btn');
            const status = document.getElementById('optimizer-status');
            const result = document.getElementById('opt-result');
            const winnerCard = document.getElementById('winner-card');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Sweeping range...';
            status.textContent = 'RUNNING';
            status.className = 'status-badge running';
            status.style.display = 'inline-block';
            result.style.display = 'none';
            winnerCard.style.display = 'none';
            
            try {
                const min = document.getElementById('opt-min').value;
                const max = document.getElementById('opt-max').value;
                const step = document.getElementById('opt-step').value;
                const sims = document.getElementById('opt-sims').value;
                const start = document.getElementById('opt-start').value;
                const seed = document.getElementById('opt-seed').value;
                
                let url = `/api/vault-optimize?min=${min}&max=${max}&step=${step}&sims=${sims}&balance=${start}`;
                if (seed) url += `&seed=${seed}`;
                url += getApiKeyParam();
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.winner) {
                    currentWinner = data.winner;
                    
                    // üèÜ v83: API returns vaultTriggerBalance as number, others as formatted strings
                    document.getElementById('winner-trigger').textContent = '$' + data.winner.vaultTriggerBalance.toFixed(2);
                    document.getElementById('winner-p100').textContent = data.winner.p100_day7;      // Already formatted "XX.XX%"
                    document.getElementById('winner-p1000').textContent = data.winner.p1000_day30;   // Already formatted "XX.XX%"
                    document.getElementById('winner-ruin').textContent = data.winner.ruinPct;        // Already formatted "XX.XX%"
                    
                    winnerCard.style.display = 'block';
                }
                
                status.textContent = 'COMPLETE';
                status.className = 'status-badge pass';
                result.className = 'result-box success';
                result.style.display = 'block';
                result.textContent = JSON.stringify(data, null, 2);
                
            } catch (e) {
                status.textContent = 'ERROR';
                status.className = 'status-badge fail';
                result.className = 'result-box error';
                result.style.display = 'block';
                result.textContent = 'Error: ' + e.message;
            }
            
            btn.disabled = false;
            btn.textContent = 'üîç Find Optimal Trigger';
        }
        
        // ==================== APPLY WINNER ====================
        async function applyWinner() {
            if (!currentWinner) {
                alert('No winner to apply. Run the optimizer first.');
                return;
            }
            
            // üèÜ v83: API returns formatted strings for stats, number for vaultTriggerBalance
            const confirmed = confirm(
                `‚ö†Ô∏è APPLY WINNER TO CONFIG ‚ö†Ô∏è\n\n` +
                `This will update your configuration to:\n` +
                `  vaultTriggerBalance = $${currentWinner.vaultTriggerBalance.toFixed(2)}\n\n` +
                `Expected performance:\n` +
                `  P($100 by day 7): ${currentWinner.p100_day7}\n` +
                `  P($1000 by day 30): ${currentWinner.p1000_day30}\n` +
                `  Ruin probability: ${currentWinner.ruinPct}\n\n` +
                `Click OK to apply, or Cancel to abort.`
            );
            
            if (!confirmed) return;
            
            const btn = document.getElementById('apply-winner-btn');
            const resultDiv = document.getElementById('apply-result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Applying...';
            
            try {
                let settingsUrl = '/api/settings';
                const apiKeyParam = getApiKeyParam();
                if (apiKeyParam) settingsUrl += '?' + apiKeyParam.substring(1); // Remove leading &
                
                const res = await fetch(settingsUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        RISK: {
                            vaultTriggerBalance: currentWinner.vaultTriggerBalance
                        }
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<span style="color:#00ff88;">‚úÖ SUCCESS! vaultTriggerBalance updated to $${currentWinner.vaultTriggerBalance.toFixed(2)}</span>`;
                } else {
                    resultDiv.innerHTML = `<span style="color:#ff4466;">‚ùå FAILED: ${data.error || 'Unknown error'}</span>`;
                }
            } catch (e) {
                resultDiv.innerHTML = `<span style="color:#ff4466;">‚ùå ERROR: ${e.message}</span>`;
            }
            
            btn.disabled = false;
            btn.textContent = 'üëë APPLY WINNER TO CONFIG (requires confirmation)';
        }
        
        // ==================== üèÜ v84 POLYMARKET OPTIMIZER ====================
        async function runPolymarketOptimizer() {
            const btn = document.getElementById('pm-opt-btn');
            const status = document.getElementById('pm-optimizer-status');
            const result = document.getElementById('pm-opt-result');
            const winnerCard = document.getElementById('pm-winner-card');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Running backtests... (can take minutes at 720h)';
            status.textContent = 'RUNNING';
            status.className = 'status-badge running';
            status.style.display = 'inline-block';
            result.style.display = 'none';
            winnerCard.style.display = 'none';
            
            try {
                const min = document.getElementById('pm-min').value;
                const max = document.getElementById('pm-max').value;
                const step = document.getElementById('pm-step').value;
                const hours = document.getElementById('pm-hours').value;
                const offsets = document.getElementById('pm-offsets').value;
                const start = document.getElementById('pm-start').value;
                const tier = document.getElementById('pm-tier').value;
                const kelly = document.getElementById('pm-kelly').value;
                
                let url = `/api/vault-optimize-polymarket?min=${min}&max=${max}&step=${step}&hours=${hours}&offsets=${encodeURIComponent(offsets)}&balance=${start}&tier=${tier}&kellyMax=${kelly}`;
                url += getApiKeyParam();
                
                const hoursNum = parseInt(hours, 10);
                const timeoutMs = Number.isFinite(hoursNum) && hoursNum >= 720 ? 600000 : 180000; // 10m for 30d, else 3m
                const res = await fetch(url, { signal: AbortSignal.timeout(timeoutMs) });
                const data = await res.json();
                
                if (data.error) {
                    status.textContent = 'ERROR';
                    status.className = 'status-badge fail';
                    result.className = 'result-box error';
                    result.style.display = 'block';
                    result.textContent = `Error: ${data.error}\n\n${data.suggestion || ''}\n\nFull response:\n${JSON.stringify(data, null, 2)}`;
                } else if (data.winner) {
                    currentPolymarketWinner = data.winner;
                    
                    // üèÜ v84: Display winner stats
                    document.getElementById('pm-winner-trigger').textContent = '$' + data.winner.vaultTriggerBalance.toFixed(2);
                    document.getElementById('pm-winner-p100').textContent = data.winner.p100_day7;
                    document.getElementById('pm-winner-p1000').textContent = data.winner.p1000_day30;
                    document.getElementById('pm-winner-ruin').textContent = data.winner.ruinPct;
                    
                    winnerCard.style.display = 'block';
                    
                    status.textContent = 'COMPLETE';
                    status.className = 'status-badge pass';
                    result.className = 'result-box success';
                    result.style.display = 'block';
                    result.textContent = JSON.stringify(data, null, 2);
                } else {
                    status.textContent = 'NO RESULTS';
                    status.className = 'status-badge fail';
                    result.className = 'result-box error';
                    result.style.display = 'block';
                    result.textContent = JSON.stringify(data, null, 2);
                }
                
            } catch (e) {
                status.textContent = 'ERROR';
                status.className = 'status-badge fail';
                result.className = 'result-box error';
                result.style.display = 'block';
                result.textContent = 'Error: ' + e.message + (e.name === 'TimeoutError' ? '\n\nTip: The Polymarket optimizer can take 1-2 minutes. Try reducing the range or increasing the step size.' : '');
            }
            
            btn.disabled = false;
            btn.textContent = 'üìà Run Polymarket Optimizer';
        }
        
        // ==================== üèÜ v84 APPLY POLYMARKET WINNER ====================
        async function applyPolymarketWinner() {
            if (!currentPolymarketWinner) {
                alert('No winner to apply. Run the Polymarket optimizer first.');
                return;
            }
            
            const confirmed = confirm(
                `‚ö†Ô∏è APPLY POLYMARKET WINNER TO CONFIG ‚ö†Ô∏è\n\n` +
                `This is the GROUND TRUTH optimal value from real Polymarket backtests.\n\n` +
                `This will update your configuration to:\n` +
                `  vaultTriggerBalance = $${currentPolymarketWinner.vaultTriggerBalance.toFixed(2)}\n\n` +
                `Observed performance across windows:\n` +
                `  P($100 by day 7): ${currentPolymarketWinner.p100_day7}\n` +
                `  P($1000 by day 30): ${currentPolymarketWinner.p1000_day30}\n` +
                `  Ruin probability: ${currentPolymarketWinner.ruinPct}\n` +
                `  Avg Max Drawdown: ${currentPolymarketWinner.avgMaxDD}\n\n` +
                `Click OK to apply, or Cancel to abort.`
            );
            
            if (!confirmed) return;
            
            const btn = document.getElementById('pm-apply-btn');
            const resultDiv = document.getElementById('pm-apply-result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Applying...';
            
            try {
                let settingsUrl = '/api/settings';
                const apiKeyParam = getApiKeyParam();
                if (apiKeyParam) settingsUrl += '?' + apiKeyParam.substring(1);
                
                const res = await fetch(settingsUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        RISK: {
                            vaultTriggerBalance: currentPolymarketWinner.vaultTriggerBalance
                        }
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<span style="color:#00ff88;">‚úÖ SUCCESS! vaultTriggerBalance updated to $${currentPolymarketWinner.vaultTriggerBalance.toFixed(2)} (POLYMARKET GROUND TRUTH)</span>`;
                } else {
                    resultDiv.innerHTML = `<span style="color:#ff4466;">‚ùå FAILED: ${data.error || 'Unknown error'}</span>`;
                }
            } catch (e) {
                resultDiv.innerHTML = `<span style="color:#ff4466;">‚ùå ERROR: ${e.message}</span>`;
            }
            
            btn.disabled = false;
            btn.textContent = 'üëë APPLY WINNER TO CONFIG (requires confirmation)';
        }
        
        // ==================== PERFECTION CHECK ====================
        async function runPerfectionCheck() {
            const btn = document.getElementById('audit-btn');
            const status = document.getElementById('audit-status');
            const summary = document.getElementById('audit-summary');
            const checksDiv = document.getElementById('audit-checks');
            const result = document.getElementById('audit-result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Running checks...';
            status.textContent = 'RUNNING';
            status.className = 'status-badge running';
            status.style.display = 'inline-block';
            summary.style.display = 'none';
            result.style.display = 'none';
            
            try {
                let checkUrl = '/api/perfection-check';
                const apiKeyParam = getApiKeyParam();
                if (apiKeyParam) checkUrl += '?' + apiKeyParam.substring(1);
                
                const res = await fetch(checkUrl);
                const data = await res.json();
                
                // Count passed/failed
                let passed = 0, failed = 0;
                let checksHtml = '';
                
                for (const [name, check] of Object.entries(data.checks || {})) {
                    const isPassed = check.status === 'pass';
                    if (isPassed) passed++; else failed++;
                    
                    checksHtml += `
                        <div class="check-item ${isPassed ? 'pass' : 'fail'}">
                            <span>${isPassed ? '‚úÖ' : '‚ùå'} ${name}</span>
                            <span style="color:${isPassed ? '#00ff88' : '#ff4466'};font-size:0.85em;">
                                ${check.details || check.status}
                            </span>
                        </div>
                    `;
                }
                
                document.getElementById('audit-passed').textContent = passed;
                document.getElementById('audit-failed').textContent = failed;
                checksDiv.innerHTML = checksHtml;
                
                summary.style.display = 'block';
                status.textContent = failed === 0 ? 'ALL PASS' : `${failed} FAILED`;
                status.className = 'status-badge ' + (failed === 0 ? 'pass' : 'fail');
                
                result.className = 'result-box ' + (failed === 0 ? 'success' : 'error');
                result.style.display = 'block';
                result.textContent = JSON.stringify(data, null, 2);
                
            } catch (e) {
                status.textContent = 'ERROR';
                status.className = 'status-badge fail';
                result.className = 'result-box error';
                result.style.display = 'block';
                result.textContent = 'Error: ' + e.message;
            }
            
            btn.disabled = false;
            btn.textContent = '‚úÖ Run Perfection Check';
        }
        
        // ==================== API EXPLORER ====================
        function onMethodChange() {
            const method = document.getElementById('api-method').value;
            document.getElementById('body-group').style.display = method === 'POST' ? 'block' : 'none';
        }
        
        function onEndpointChange() {
            const select = document.getElementById('api-endpoint');
            const option = select.options[select.selectedIndex];
            const isDangerous = option.dataset.dangerous === 'true';
            const method = option.dataset.method || 'GET';
            
            document.getElementById('api-method').value = method;
            onMethodChange();
            
            const warning = document.getElementById('safety-warning');
            const confirm = document.getElementById('safety-confirm');
            
            if (isDangerous) {
                warning.classList.add('visible');
                confirm.checked = false;
            } else {
                warning.classList.remove('visible');
            }
        }
        
        async function makeApiRequest() {
            const select = document.getElementById('api-endpoint');
            const option = select.options[select.selectedIndex];
            const isDangerous = option.dataset.dangerous === 'true';
            
            if (isDangerous && !document.getElementById('safety-confirm').checked) {
                alert('‚ö†Ô∏è You must confirm that you understand the risks before making this request.');
                return;
            }
            
            const btn = document.getElementById('api-btn');
            const result = document.getElementById('api-result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Sending...';
            result.style.display = 'none';
            
            try {
                const method = document.getElementById('api-method').value;
                let endpoint = document.getElementById('api-endpoint').value;
                const paramsText = document.getElementById('api-params').value;
                
                // Add query params
                if (paramsText && paramsText.trim() !== '') {
                    try {
                        const params = JSON.parse(paramsText);
                        const queryString = new URLSearchParams(params).toString();
                        if (queryString) {
                            endpoint += (endpoint.includes('?') ? '&' : '?') + queryString;
                        }
                    } catch (e) {
                        throw new Error('Invalid query params JSON: ' + e.message);
                    }
                }
                
                // üèÜ v83: Append apiKey from URL if present
                const apiKeyParam = getApiKeyParam();
                endpoint += apiKeyParam;
                
                const options = { method };
                
                if (method === 'POST') {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = document.getElementById('api-body').value;
                }
                
                const res = await fetch(endpoint, options);
                const data = await res.json();
                
                result.className = 'result-box ' + (res.ok ? 'success' : 'error');
                result.style.display = 'block';
                result.textContent = `Status: ${res.status} ${res.statusText}\n\n${JSON.stringify(data, null, 2)}`;
                
            } catch (e) {
                result.className = 'result-box error';
                result.style.display = 'block';
                result.textContent = 'Error: ' + e.message;
            }
            
            btn.disabled = false;
            btn.textContent = 'üöÄ Send Request';
        }
        
        function quickCall(url) {
            document.getElementById('api-endpoint').value = url.split('?')[0];
            if (url.includes('?')) {
                const params = {};
                new URLSearchParams(url.split('?')[1]).forEach((v, k) => params[k] = v);
                document.getElementById('api-params').value = JSON.stringify(params);
            } else {
                document.getElementById('api-params').value = '';
            }
            document.getElementById('api-method').value = 'GET';
            onMethodChange();
            document.getElementById('safety-warning').classList.remove('visible');
            
            // Switch to explorer tab and make request (manual switch since no click event)
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[onclick*="explorer"]').classList.add('active');
            document.getElementById('explorer-tab').classList.add('active');
            
            makeApiRequest();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üõ†Ô∏è POLYPROPHET Tools UI loaded');
            onEndpointChange();
        });
    </script>
</body>
</html>

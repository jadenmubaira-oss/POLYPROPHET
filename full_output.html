<!DOCTYPE html>
<html>

<head>
    <title>üîÆ Supreme Oracle - Prophet Trading System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0f1c 0%, #1a1f3c 50%, #0d1225 100%);
            color: #e0e8ff;
            min-height: 100vh;
        }

        .nav {
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(100, 150, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .nav-brand {
            font-size: 1.4em;
            font-weight: bold;
            color: #ffd700;
        }

        .nav-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(100, 150, 255, 0.2);
            border: 1px solid rgba(100, 150, 255, 0.3);
            color: #88ccff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(100, 150, 255, 0.4);
            transform: scale(1.05);
        }

        .nav-btn.live {
            background: rgba(255, 0, 100, 0.3);
            border-color: #ff0066;
            color: #ff88aa;
        }

        .nav-btn.paper {
            background: rgba(255, 150, 0, 0.3);
            border-color: #ff9800;
            color: #ffcc80;
        }

        .status-bar {
            background: linear-gradient(90deg, rgba(0, 255, 100, 0.1), rgba(0, 200, 255, 0.1));
            padding: 10px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 1px solid rgba(0, 255, 100, 0.2);
        }

        .countdown {
            font-size: 1.6em;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 15px #00ff88;
        }

        .balance-display .amount {
            color: #ffd700;
            font-weight: bold;
        }

        .mode-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8em;
        }

        .mode-badge.PAPER {
            background: #ff9800;
            color: #000;
        }

        .mode-badge.LIVE {
            background: #ff0066;
            color: #fff;
            animation: pulse 2s infinite;
        }

        .main-container {
            padding: 15px;
            max-width: 1500px;
            margin: 0 auto;
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .asset-card {
            background: linear-gradient(145deg, rgba(20, 30, 60, 0.9), rgba(10, 20, 40, 0.95));
            border-radius: 14px;
            padding: 18px;
            border: 2px solid rgba(100, 150, 255, 0.15);
            transition: all 0.3s;
        }

        .asset-card:hover {
            transform: translateY(-3px);
            border-color: rgba(100, 150, 255, 0.4);
            box-shadow: 0 8px 30px rgba(0, 100, 255, 0.2);
        }

        .asset-card.locked {
            border-color: #ff0066;
            box-shadow: 0 0 25px rgba(255, 0, 100, 0.3);
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .asset-name {
            font-size: 1.5em;
            font-weight: bold;
        }

        .asset-price {
            color: #88ccff;
            font-size: 0.9em;
        }

        .prediction {
            text-align: center;
            margin: 15px 0;
        }

        .prediction-value {
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 0 25px currentColor;
        }

        .prediction-value.UP {
            color: #00ff88;
        }

        .prediction-value.DOWN {
            color: #ff4466;
        }

        .prediction-value.WAIT {
            color: #ffaa00;
            font-size: 2em;
        }

        .confidence-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 12px 0 8px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }

        .confidence-fill.high {
            background: linear-gradient(90deg, #00ff88, #00cc66);
        }

        .confidence-fill.medium {
            background: linear-gradient(90deg, #ffaa00, #ff8800);
        }

        .confidence-fill.low {
            background: linear-gradient(90deg, #ff4466, #cc2244);
        }

        .tier {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8em;
        }

        .tier.CONVICTION {
            background: linear-gradient(90deg, #ff0066, #cc0055);
        }

        .tier.ADVISORY {
            background: linear-gradient(90deg, #ff9900, #cc7700);
        }

        .tier.NONE {
            background: #444;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 0.7em;
            color: #888;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 1em;
            font-weight: bold;
            color: #88ccff;
        }

        .market-link {
            display: block;
            text-align: center;
            margin-top: 12px;
            color: #4fc3f7;
            text-decoration: none;
            font-size: 0.8em;
        }

        .trading-panel {
            background: linear-gradient(145deg, rgba(20, 30, 60, 0.9), rgba(10, 20, 40, 0.95));
            border-radius: 14px;
            padding: 20px;
            border: 2px solid rgba(100, 150, 255, 0.15);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .panel-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }

        .positions-list {
            max-height: 180px;
            overflow-y: auto;
        }

        .position-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .no-positions {
            text-align: center;
            color: #666;
            padding: 15px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(145deg, #1a2040, #0d1530);
            border-radius: 16px;
            padding: 25px;
            max-width: 650px;
            width: 92%;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid rgba(100, 150, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 12px;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #888;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #ff4466;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #88ccff;
            font-weight: bold;
            font-size: 0.85em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid rgba(100, 150, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            font-size: 0.95em;
        }

        .form-group input:focus {
            border-color: #4fc3f7;
            outline: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(90deg, #4fc3f7, #2196f3);
            color: #fff;
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }

        .btn-danger {
            background: linear-gradient(90deg, #ff4466, #cc2244);
            color: #fff;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-toggle button {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            cursor: pointer;
            font-weight: bold;
        }

        .mode-toggle button.active.paper {
            border-color: #ff9800;
            background: rgba(255, 150, 0, 0.3);
        }

        .mode-toggle button.active.live {
            border-color: #ff0066;
            background: rgba(255, 0, 100, 0.3);
        }

        .wallet-balances {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .balance-card {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .balance-amount {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffd700;
        }

        .balance-label {
            color: #888;
            font-size: 0.85em;
            margin-top: 4px;
        }

        .address-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8em;
            word-break: break-all;
            margin-bottom: 12px;
        }

        .guide-section {
            margin-bottom: 20px;
        }

        .guide-section h3 {
            color: #00ff88;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .guide-section p {
            color: #aaa;
            line-height: 1.5;
            font-size: 0.9em;
        }

        .mode-card {
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid;
            font-size: 0.9em;
        }

        .mode-card.oracle {
            border-color: #9933ff;
        }

        .mode-card.arb {
            border-color: #00ff88;
        }

        .mode-card.scalp {
            border-color: #ff6600;
        }

        .status-msg {
            padding: 10px;
            border-radius: 6px;
            margin-top: 12px;
            text-align: center;
            display: none;
            font-size: 0.9em;
        }

        .status-msg.success {
            background: rgba(0, 255, 100, 0.2);
            border: 1px solid #00ff88;
            display: block;
        }

        .status-msg.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff4466;
            display: block;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                gap: 10px;
            }

            .status-bar {
                flex-direction: column;
                text-align: center;
            }

            .predictions-grid {
                grid-template-columns: 1fr;
            }

            .form-grid,
            .wallet-balances {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <nav class="nav">
        <div class="nav-brand">üîÆ Supreme Oracle</div>
        <div class="nav-links">
            <button class="nav-btn" onclick="openModal('walletModal')">üí∞ Wallet</button>
            <button class="nav-btn" onclick="openModal('settingsModal')">‚öôÔ∏è Settings</button>
            <button class="nav-btn" onclick="openModal('guideModal')">üìö Guide</button>
            <button class="nav-btn" onclick="openModal('pendingSellsModal'); loadPendingSells();">üîÑ Recovery</button>
            <button class="nav-btn" id="modeBtn">üìù PAPER</button>
        </div>
    </nav>
    <div class="status-bar">
        <div><span style="color:#888;">Next:</span> <span class="countdown" id="countdown">--:--</span></div>
        <div class="balance-display">
            <span style="color:#888;">Paper:</span> <span class="amount" id="balance">$0.00</span>
            <span style="color:#888;margin-left:15px;">Live USDC:</span> <span class="amount" id="liveBalance"
                style="color:#00ff88;">$0.00</span>
            <span style="color:#888;margin-left:15px;">P/L:</span> <span id="pnl" style="color:#00ff88;">$0.00</span>
            <span style="color:#888;margin-left:15px;">W/L:</span> <span id="winLoss" style="color:#ffd700;">0/0</span>
        </div>
        <span class="mode-badge" id="modeBadge">PAPER</span>
    </div>
    <div class="main-container">
        <div class="predictions-grid" id="predictionsGrid">
            <div style="text-align:center;padding:40px;color:#666;">Loading predictions...</div>
        </div>
        <div class="trading-panel">
            <div class="panel-header"><span class="panel-title">üìä Active Positions</span><span id="positionCount">0
                    positions</span></div>
            <div class="positions-list" id="positionsList">
                <div class="no-positions">No active positions</div>
            </div>
        </div>
        <div class="trading-panel" style="margin-top:15px;">
            <div class="panel-header"><span class="panel-title">üìú Trade History</span><span id="historyCount">0
                    trades</span></div>
            <div class="positions-list" id="tradeHistory">
                <div class="no-positions">No trades yet</div>
            </div>
        </div>
    </div>
    <!-- WALLET MODAL -->
    <div class="modal-overlay" id="walletModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">üí∞ Wallet</span><button class="modal-close"
                    onclick="closeModal('walletModal')">√ó</button></div>
            <div class="wallet-balances">
                <div class="balance-card">
                    <div class="balance-amount" id="usdcBalance">$0.00</div>
                    <div class="balance-label">USDC (Trading)</div>
                </div>
                <div class="balance-card">
                    <div class="balance-amount" id="maticBalance" style="color:#8b5cf6;">0.00</div>
                    <div class="balance-label">MATIC (Gas)</div>
                </div>
            </div>
            <h4 style="margin-bottom:8px;color:#00ff88;font-size:0.95em;">üì• Deposit Address</h4>
            <div class="address-box" id="depositAddress">Loading...</div>
            <button class="btn btn-primary" onclick="copyAddress()" style="width:100%;margin-bottom:15px;">üìã Copy
                Address</button>
            <h4 style="margin-bottom:10px;color:#ff9900;font-size:0.95em;">üì§ Withdraw USDC</h4>
            <div class="form-group"><label>Destination</label><input type="text" id="withdrawTo" placeholder="0x...">
            </div>
            <div class="form-group"><label>Amount</label><input type="number" id="withdrawAmount" placeholder="0.00"
                    step="0.01"></div>
            <button class="btn btn-danger" onclick="handleWithdraw()" style="width:100%;">üí∏ Send</button>
            <div class="status-msg" id="withdrawStatus"></div>
        </div>
    </div>
    <!-- SETTINGS MODAL (ENHANCED with Mode Config) -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width:750px;">
            <div class="modal-header"><span class="modal-title">‚öôÔ∏è Settings</span><button class="modal-close"
                    onclick="closeModal('settingsModal')">√ó</button></div>

            <h4 style="margin-bottom:10px;color:#ffd700;font-size:0.95em;">üîÑ Trading Mode</h4>
            <div class="mode-toggle">
                <button class="paper" id="paperBtn" onclick="setMode('PAPER')">üìù PAPER</button>
                <button class="live" id="liveBtn" onclick="setMode('LIVE')">üî¥ LIVE</button>
            </div>

            <h4 style="margin:15px 0 10px;color:#00ff88;font-size:0.95em;">üéÆ Quick Presets (Beginner Friendly)</h4>
            <div style="display:flex;gap:10px;margin-bottom:10px;">
                <button onclick="applyPreset('PINNACLE_V14')"
                    style="flex:1;padding:12px;border:2px solid #ffd700;border-radius:8px;background:linear-gradient(145deg,rgba(255,215,0,0.25),rgba(255,170,0,0.15));color:#ffd700;cursor:pointer;font-weight:bold;box-shadow:0 0 15px rgba(255,215,0,0.3);">üîÆ
                    PINNACLE v14<br><small style="font-weight:normal;opacity:0.7;">AI Optimized</small></button>
            </div>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
                <button onclick="applyPreset('CONSERVATIVE')"
                    style="flex:1;padding:12px;border:2px solid #00ff88;border-radius:8px;background:rgba(0,255,136,0.15);color:#00ff88;cursor:pointer;font-weight:bold;">üõ°Ô∏è
                    Safe<br><small style="font-weight:normal;opacity:0.7;">Low Risk</small></button>
                <button onclick="applyPreset('BALANCED')"
                    style="flex:1;padding:12px;border:2px solid #ffaa00;border-radius:8px;background:rgba(255,170,0,0.15);color:#ffaa00;cursor:pointer;font-weight:bold;">‚öñÔ∏è
                    Balanced<br><small style="font-weight:normal;opacity:0.7;">Medium Risk</small></button>
                <button onclick="applyPreset('AGGRESSIVE')"
                    style="flex:1;padding:12px;border:2px solid #ff4466;border-radius:8px;background:rgba(255,68,102,0.15);color:#ff4466;cursor:pointer;font-weight:bold;">üî•
                    Aggressive<br><small style="font-weight:normal;opacity:0.7;">High Risk</small></button>
            </div>

            <h4 style="margin:15px 0 10px;color:#ffd700;font-size:0.95em;">üí∞ Core Parameters</h4>
            <div class="form-grid">
                <div class="form-group"><label>Paper Balance ($)</label><input type="number" id="paperBalance"
                        value="1000"></div>
                <div class="form-group"><label>Max Position (%)</label><input type="number" id="maxPosition" value="10"
                        min="1" max="25"></div>
            </div>
            <button class="btn" onclick="resetPaperBalance()"
                style="width:100%;margin-bottom:15px;background:#ff6600;">üîÑ Reset Paper Balance to Starting
                Value</button>

            <!-- MODE CONFIGURATIONS -->
            <h4 style="margin:15px 0 10px;color:#00ff88;font-size:0.95em;cursor:pointer;" onclick="toggleModeConfig()">
                üéØ Mode Configuration ‚ñº</h4>
            <div id="modeConfigPanel"
                style="display:none;background:rgba(0,0,0,0.3);border-radius:8px;padding:12px;margin-bottom:15px;">
                <!-- ORACLE -->
                <div
                    style="margin-bottom:12px;padding:10px;background:rgba(153,51,255,0.1);border-left:3px solid #9933ff;border-radius:4px;">
                    <strong style="color:#9933ff;">üîÆ ORACLE</strong>
                    <label style="float:right;color:#888;"><input type="checkbox" id="oracleEnabled" checked>
                        Enabled</label>
                    <div class="form-grid" style="margin-top:8px;">
                        <div class="form-group"><label>Min Consensus</label><input type="number" id="oracleConsensus"
                                value="0.85" step="0.05" min="0.5" max="1"></div>
                        <div class="form-group"><label>Min Confidence</label><input type="number" id="oracleConfidence"
                                value="0.92" step="0.02" min="0.5" max="1"></div>
                        <div class="form-group"><label>Min Edge (%)</label><input type="number" id="oracleEdge"
                                value="15" min="5" max="50"></div>
                        <div class="form-group"><label>Max Odds</label><input type="number" id="oracleMaxOdds"
                                value="0.70" step="0.05" min="0.3" max="0.9"></div>
                    </div>
                    <div class="form-group" style="margin-top:10px;">
                        <label>üîÆ Aggression (0=Conservative, 100=Aggressive)</label>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <input type="range" id="oracleAggression" min="0" max="100" value="50" style="flex:1;"
                                oninput="document.getElementById('aggressionValue').textContent=this.value+'%'">
                            <span id="aggressionValue" style="color:#ffd700;font-weight:bold;min-width:40px;">50%</span>
                        </div>
                        <small style="color:#888;">Higher = more trades, lower thresholds (quality still
                            protected)</small>
                    </div>
                </div>
                <!-- SCALP -->
                <div
                    style="margin-bottom:12px;padding:10px;background:rgba(255,102,0,0.1);border-left:3px solid #ff6600;border-radius:4px;">
                    <strong style="color:#ff6600;">üéØ SCALP</strong>
                    <label style="float:right;color:#888;"><input type="checkbox" id="scalpEnabled" checked>
                        Enabled</label>
                    <div class="form-grid" style="margin-top:8px;">
                        <div class="form-group"><label>Max Entry (¬¢)</label><input type="number" id="scalpMaxEntry"
                                value="20" min="5" max="40"></div>
                        <div class="form-group"><label>Target Multiple</label><input type="number" id="scalpTarget"
                                value="2.0" step="0.5" min="1.5" max="5"></div>
                    </div>
                </div>
                <!-- ARBITRAGE -->
                <div
                    style="margin-bottom:12px;padding:10px;background:rgba(0,255,136,0.1);border-left:3px solid #00ff88;border-radius:4px;">
                    <strong style="color:#00ff88;">üìä ARBITRAGE</strong>
                    <label style="float:right;color:#888;"><input type="checkbox" id="arbEnabled" checked>
                        Enabled</label>
                    <div class="form-grid" style="margin-top:8px;">
                        <div class="form-group"><label>Min Mispricing</label><input type="number" id="arbMispricing"
                                value="0.15" step="0.05" min="0.05" max="0.5"></div>
                        <div class="form-group"><label>Target Profit</label><input type="number" id="arbTarget"
                                value="0.50" step="0.1" min="0.1" max="1"></div>
                        <div class="form-group"><label>Stop Loss</label><input type="number" id="arbStopLoss"
                                value="0.30" step="0.05" min="0.1" max="0.5"></div>
                    </div>
                </div>
                <!-- UNCERTAINTY -->
                <div
                    style="margin-bottom:12px;padding:10px;background:rgba(51,153,255,0.1);border-left:3px solid #3399ff;border-radius:4px;">
                    <strong style="color:#3399ff;">üåä UNCERTAINTY</strong>
                    <label style="float:right;color:#888;"><input type="checkbox" id="uncEnabled" checked>
                        Enabled</label>
                    <div class="form-grid" style="margin-top:8px;">
                        <div class="form-group"><label>Extreme Threshold</label><input type="number" id="uncThreshold"
                                value="0.80" step="0.05" min="0.6" max="0.95"></div>
                        <div class="form-group"><label>Target Reversion</label><input type="number" id="uncTarget"
                                value="0.60" step="0.05" min="0.4" max="0.7"></div>
                        <div class="form-group"><label>Stop Loss</label><input type="number" id="uncStopLoss"
                                value="0.25" step="0.05" min="0.1" max="0.5"></div>
                    </div>
                </div>
                <!-- MOMENTUM -->
                <div
                    style="margin-bottom:12px;padding:10px;background:rgba(255,51,204,0.1);border-left:3px solid #ff33cc;border-radius:4px;">
                    <strong style="color:#ff33cc;">üöÄ MOMENTUM</strong>
                    <label style="float:right;color:#888;"><input type="checkbox" id="momEnabled" checked>
                        Enabled</label>
                    <div class="form-grid" style="margin-top:8px;">
                        <div class="form-group"><label>Min Elapsed (s)</label><input type="number" id="momMinElapsed"
                                value="300" min="60" max="600"></div>
                        <div class="form-group"><label>Min Consensus</label><input type="number" id="momConsensus"
                                value="0.75" step="0.05" min="0.5" max="1"></div>
                        <div class="form-group"><label>Exit Before End (s)</label><input type="number"
                                id="momExitBefore" value="180" min="60" max="300"></div>
                    </div>
                </div>
                <!-- RISK -->
                <div
                    style="padding:10px;background:rgba(255,0,100,0.1);border-left:3px solid #ff0066;border-radius:4px;">
                    <strong style="color:#ff0066;">‚ö†Ô∏è RISK MANAGEMENT</strong>
                    <div class="form-grid" style="margin-top:8px;">
                        <div class="form-group"><label>Max Exposure (%)</label><input type="number" id="riskMaxExposure"
                                value="30" min="10" max="100"></div>
                        <div class="form-group"><label>Daily Stop (%)</label><input type="number" id="riskStopLoss"
                                value="20" min="5" max="50"></div>
                        <div class="form-group"><label>Loss Cooldown (s)</label><input type="number" id="riskCooldown"
                                value="300" min="60" max="900"></div>
                    </div>
                </div>
            </div>

            <h4 style="margin-bottom:10px;color:#ffd700;font-size:0.95em;">üîë API Credentials</h4>
            <div class="form-group"><label>API Key</label><input type="text" id="apiKey" placeholder="019aed53-...">
            </div>
            <div class="form-group"><label>Secret</label><input type="password" id="apiSecret"
                    placeholder="Enter secret..."></div>
            <div class="form-group"><label>Passphrase</label><input type="password" id="apiPassphrase"
                    placeholder="Enter passphrase..."></div>
            <div class="form-group"><label>Private Key (‚ö†Ô∏è)</label><input type="password" id="privateKey"
                    placeholder="0x..."></div>
            <button class="btn btn-primary" onclick="saveAllSettings()" style="width:100%;">üíæ Save All
                Settings</button>
            <div class="status-msg" id="settingsStatus"></div>
        </div>
    </div>
    <!-- GUIDE MODAL -->
    <div class="modal-overlay" id="guideModal">
        <div class="modal" style="max-height:90vh;overflow-y:auto;">
            <div class="modal-header"><span class="modal-title">üìö Guide</span><button class="modal-close"
                    onclick="closeModal('guideModal')">√ó</button></div>
            <div class="guide-section">
                <h3>üéØ What Is This?</h3>
                <p>AI prediction bot for Polymarket 15-min crypto markets. 8 ML models predict BTC, ETH, SOL, XRP
                    direction.</p>
            </div>
            <div class="guide-section">
                <h3>üîÆ The 5 Trading Modes</h3>
                <div class="mode-card oracle"><strong>ORACLE üîÆ</strong> - Hold to resolution @ 92%+ confidence, 15%+
                    edge. Highest accuracy trades.</div>
                <div class="mode-card arb"><strong>ARBITRAGE üìä</strong> - Buy mispriced odds, sell when market
                    corrects. Exit at 50% profit or 10min.</div>
                <div class="mode-card scalp"><strong>SCALP üéØ</strong> - Buy under 20¬¢, exit at 2x profit. Exits before
                    resolution for safety.</div>
                <div class="mode-card" style="border-left:3px solid #3399ff;"><strong>UNCERTAINTY üåä</strong> - When
                    odds hit 80%+, bet on reversion to 50/50. Works in choppy markets.</div>
                <div class="mode-card" style="border-left:3px solid #ff33cc;"><strong>MOMENTUM üöÄ</strong> - Ride
                    breakouts mid-cycle. Entry after 5min with 75%+ model agreement.</div>
            </div>
            <div class="guide-section">
                <h3>üéöÔ∏è Oracle Aggression</h3>
                <p><strong>0%:</strong> Conservative - base thresholds<br><strong>50%:</strong> Balanced - 15% threshold
                    reduction<br><strong>100%:</strong> Aggressive - 30% reduction, max opportunities<br>Access:
                    Settings ‚Üí Mode Config ‚Üí ORACLE</p>
            </div>
            <div class="guide-section">
                <h3>üìä Dashboard</h3>
                <p><strong>Prediction:</strong> UP/DOWN direction<br><strong>Confidence:</strong> 0-100%
                    certainty<br><strong>Tier:</strong> CONVICTION (best) or ADVISORY<br><strong>Edge:</strong>
                    Advantage over market</p>
            </div>
            <div class="guide-section">
                <h3>üîÑ Failed Sells Recovery</h3>
                <p>If sell fails after 5 retries, saved with recovery info at <code>/api/pending-sells</code>. Includes
                    tokenId, conditionId, marketSlug, PolygonScan link, and manual redemption instructions.</p>
            </div>
            <div class="guide-section">
                <h3>‚ö†Ô∏è Paper vs Live</h3>
                <p><strong>PAPER:</strong> Simulated - no risk<br><strong>LIVE:</strong> Real money - needs USDC + MATIC
                </p>
            </div>
        </div>
    </div>
    <!-- PENDING SELLS / RECOVERY MODAL -->
    <div class="modal-overlay" id="pendingSellsModal">
        <div class="modal" style="max-width:850px;max-height:90vh;overflow-y:auto;">
            <div class="modal-header"><span class="modal-title">üîÑ Pending Sells / Recovery</span><button
                    class="modal-close" onclick="closeModal('pendingSellsModal')">√ó</button></div>
            <div
                style="padding:10px;background:rgba(255,150,0,0.1);border-radius:8px;margin-bottom:15px;border-left:3px solid #ff9900;">
                <p style="color:#ff9900;margin:0;font-size:0.9em;">‚ö†Ô∏è <strong>Failed Sells</strong>: These positions
                    failed to sell after 5 retries. Use the info below to manually recover your funds.</p>
            </div>
            <div id="pendingSellsList" style="min-height:100px;">
                <div style="text-align:center;color:#666;padding:30px;">Loading...</div>
            </div>
            <div style="margin-top:15px;padding:12px;background:rgba(0,0,0,0.3);border-radius:8px;">
                <h4 style="color:#00ff88;margin-bottom:8px;font-size:0.95em;">üìñ Manual Recovery Steps</h4>
                <ol style="color:#aaa;font-size:0.85em;margin-left:20px;line-height:1.6;">
                    <li>Go to <a href="https://polymarket.com/portfolio" target="_blank"
                            style="color:#4fc3f7;">polymarket.com/portfolio</a></li>
                    <li>Find the position in your "Open Positions"</li>
                    <li>Click "Sell" and manually complete the transaction</li>
                    <li>Or wait for market resolution and redeem winning shares</li>
                </ol>
            </div>
            <p style="color:#666;font-size:0.8em;margin-top:10px;text-align:center;">Auto-updates every 10 seconds |
                API: <code>/api/pending-sells</code></p>
        </div>
    </div>
    <script>
        console.log('SCRIPT STARTING v2');
        let currentData = null;
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));

        async function fetchData() {
            try {
                console.log('fetchData called');
                const res = await fetch('/api/state');
                if (!res.ok) { console.error('API error:', res.status); return; }
                currentData = await res.json();
                console.log('Data received:', Object.keys(currentData));
                updateUI(currentData);
            } catch (e) { console.error('Fetch error:', e); }
        }

        function updateUI(data) {
            try {
                console.log('updateUI called');
                // Always update countdown first
                const now = Math.floor(Date.now() / 1000);
                const next = now - (now % 900) + 900;
                const remaining = next - now;
                document.getElementById('countdown').textContent = Math.floor(remaining / 60) + ':' + (remaining % 60).toString().padStart(2, '0');

                if (!data) { console.error('No data received'); return; }

                // RENDER PREDICTION CARDS
                const assets = ['BTC', 'ETH', 'SOL', 'XRP'];
                let html = '';
                assets.forEach(asset => {
                    try {
                        const d = data[asset];
                        // Handle missing data gracefully - show waiting card
                        if (!d || (!d.live && !d.checkpoint)) {
                            html += '<div class="asset-card"><div class="asset-header"><span class="asset-name">' + asset + '</span><span class="asset-price" style="color:#888;">Awaiting data...</span></div>' +
                                '<div class="prediction"><div class="prediction-value WAIT" style="font-size:1.5em;">‚è≥ WAITING</div></div>' +
                                '<div style="text-align:center;color:#666;padding:20px;">Waiting for Chainlink price feed...</div></div>';
                            return;
                        }
                        const conf = ((d.confidence || 0) * 100).toFixed(0);
                        const confClass = conf >= 70 ? 'high' : conf >= 50 ? 'medium' : 'low';
                        const priceDecimals = asset === 'XRP' ? 4 : 2;
                        const price = d.live ? d.live.toLocaleString('en-US', { minimumFractionDigits: priceDecimals, maximumFractionDigits: priceDecimals }) : '--';
                        const change = d.checkpoint && d.live ? (((d.live / d.checkpoint) - 1) * 100).toFixed(3) : 0;
                        const stats = d.stats || { total: 0, wins: 0 };
                        const winRate = stats.total > 0 ? ((stats.wins / stats.total) * 100).toFixed(0) : '--';
                        const marketUrl = d.market?.marketUrl || '#';
                        const cpPrice = d.checkpoint ? '$' + d.checkpoint.toLocaleString('en-US', { minimumFractionDigits: priceDecimals, maximumFractionDigits: priceDecimals }) : '--';
                        const recentOutcomes = d.recentOutcomes || [];
                        let wlTracker = '';
                        for (let i = 0; i < 10; i++) {
                            if (i < recentOutcomes.length) {
                                wlTracker += recentOutcomes[i] ? '<span style="color:#00ff88;">‚úì</span>' : '<span style="color:#ff4466;">‚úó</span>';
                            } else {
                                wlTracker += '<span style="color:#444;">‚óã</span>';
                            }
                        }
                        const recentWins = recentOutcomes.filter(Boolean).length;
                        const recentTotal = recentOutcomes.length;
                        const yesOdds = d.market && d.market.yesPrice ? (d.market.yesPrice * 100).toFixed(1) : '--';
                        const noOdds = d.market && d.market.noPrice ? (d.market.noPrice * 100).toFixed(1) : '--';
                        html += '<div class="asset-card ' + (d.locked ? 'locked' : '') + '">' +
                            '<div class="asset-header"><span class="asset-name">' + asset + '</span><span class="asset-price">$' + price + ' <span style="color:' + (change >= 0 ? '#00ff88' : '#ff4466') + '">(' + (change >= 0 ? '+' : '') + change + '%)</span></span></div>' +
                            '<div class="prediction"><div class="prediction-value ' + (d.prediction || 'WAIT') + '">' + (d.prediction || 'WAIT') + '</div></div>' +
                            '<div class="confidence-bar"><div class="confidence-fill ' + confClass + '" style="width:' + conf + '%"></div></div>' +
                            '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;"><span>' + conf + '% Confidence</span><span class="tier ' + (d.tier || 'NONE') + '">' + (d.tier || 'NONE') + (d.locked ? ' üîí' : '') + '</span></div>' +
                            '<div style="text-align:center;padding:6px;background:rgba(255,215,0,0.1);border-radius:4px;margin-top:8px;"><span style="color:#888;font-size:0.8em;">Checkpoint: </span><span style="color:#ffd700;font-weight:bold;">' + cpPrice + '</span></div>' +
                            '<div class="stats-grid"><div class="stat"><div class="stat-label">Win</div><div class="stat-value">' + winRate + '%</div></div>' +
                            '<div class="stat"><div class="stat-label">Edge</div><div class="stat-value">' + (d.edge ? d.edge.toFixed(2) : '0') + '%</div></div>' +
                            '<div class="stat"><div class="stat-label">YES</div><div class="stat-value">' + yesOdds + '¬¢</div></div>' +
                            '<div class="stat"><div class="stat-label">NO</div><div class="stat-value">' + noOdds + '¬¢</div></div></div>' +
                            '<div style="text-align:center;padding:6px;background:rgba(0,0,0,0.2);border-radius:4px;margin-top:8px;font-size:1.1em;letter-spacing:2px;"><span style="color:#888;font-size:0.7em;display:block;margin-bottom:2px;">Last 10: ' + recentWins + '/' + recentTotal + '</span>' + wlTracker + '</div>' +
                            '<div style="display:flex;gap:8px;margin-top:10px;">' +
                            '<button onclick="manualBuy(' + "'" + asset + "'" + ', ' + "'" + 'UP' + "'" + ')" style="flex:1;padding:8px;background:linear-gradient(135deg,#00ff88,#00cc66);border:none;border-radius:6px;color:#000;font-weight:bold;cursor:pointer;font-size:0.85em;">üìà BUY UP<br><small>' + yesOdds + '¬¢</small></button>' +
                            '<button onclick="manualBuy(' + "'" + asset + "'" + ', ' + "'" + 'DOWN' + "'" + ')" style="flex:1;padding:8px;background:linear-gradient(135deg,#ff4466,#cc2244);border:none;border-radius:6px;color:#fff;font-weight:bold;cursor:pointer;font-size:0.85em;">üìâ BUY DOWN<br><small>' + noOdds + '¬¢</small></button>' +
                            '</div>' +
                            '<a href="' + marketUrl + '" target="_blank" class="market-link">Polymarket ‚Üí</a></div>';
                    } catch (assetErr) { console.error('Error rendering asset:', asset, assetErr); }
                });
                console.log('HTML built for ' + assets.length + ' assets, length: ' + html.length);
                const grid = document.getElementById('predictionsGrid');
                if (grid) {
                    grid.innerHTML = html || '<div style="text-align:center;padding:40px;color:#ff6666;">No prediction data available</div>';
                    console.log('Grid updated successfully');
                } else {
                    console.error('predictionsGrid element not found!');
                }

                const t = data._trading;
                if (t) {
                    document.getElementById('balance').textContent = '$' + (t.balance || 0).toFixed(2);
                    document.getElementById('pnl').textContent = ((t.todayPnL || 0) >= 0 ? '+' : '') + '$' + (t.todayPnL || 0).toFixed(2);
                    document.getElementById('pnl').style.color = (t.todayPnL || 0) >= 0 ? '#00ff88' : '#ff4466';
                    const allTrades = t.tradeHistory || [];
                    const closedT = allTrades.filter(tr => tr.status === 'CLOSED');
                    const winsCount = closedT.filter(tr => (tr.pnl || 0) >= 0).length;
                    const lossCount = closedT.length - winsCount;
                    document.getElementById('winLoss').textContent = winsCount + '/' + lossCount;
                    document.getElementById('winLoss').style.color = winsCount >= lossCount ? '#00ff88' : '#ff4466';
                    document.getElementById('modeBadge').textContent = t.mode || 'PAPER';
                    document.getElementById('modeBadge').className = 'mode-badge ' + (t.mode || 'PAPER');
                    document.getElementById('modeBtn').textContent = t.mode === 'LIVE' ? 'üî¥ LIVE' : 'üìù PAPER';
                    document.getElementById('modeBtn').className = 'nav-btn ' + (t.mode || 'paper').toLowerCase();
                    document.getElementById('positionCount').textContent = (t.positionCount || 0) + ' positions';
                    document.getElementById('paperBtn').className = t.mode === 'PAPER' ? 'paper active' : 'paper';
                    document.getElementById('liveBtn').className = t.mode === 'LIVE' ? 'live active' : 'live';
                    const positions = Object.entries(t.positions || {});
                    if (positions.length > 0) {
                        let posHtml = '';
                        positions.forEach(([id, p]) => {
                            const timeHeld = Math.floor((Date.now() - (p.time || Date.now())) / 1000);
                            const mins = Math.floor(timeHeld / 60);
                            const secs = timeHeld % 60;
                            const color = p.side === 'UP' ? '#00ff88' : '#ff4466';
                            const modeEmoji = p.mode === 'ORACLE' ? 'üîÆ' : p.mode === 'SCALP' ? 'üéØ' : p.mode === 'ARBITRAGE' ? 'üìä' : p.mode === 'MANUAL' ? '‚úã' : '‚ö°';
                            const modeColor = p.mode === 'ORACLE' ? '#9933ff' : p.mode === 'SCALP' ? '#ff6600' : p.mode === 'ARBITRAGE' ? '#00ff88' : p.mode === 'MANUAL' ? '#ffd700' : '#ffaa00';
                            posHtml += '<div class="position-item" style="flex-wrap:wrap;"><div style="display:flex;justify-content:space-between;width:100%;align-items:center;"><span style="color:' + color + '"><strong>' + (p.asset || '?') + '</strong> ' + (p.side || '?') + '</span><span style="color:' + modeColor + ';font-weight:bold;font-size:0.85em;background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;">' + modeEmoji + ' ' + (p.mode || '?') + '</span><span>$' + (p.size || 0).toFixed(2) + ' @ ' + ((p.entry || 0) * 100).toFixed(0) + '¬¢ <span style="color:#888;font-size:0.8em;">' + mins + 'm' + secs + 's</span></span><button onclick="manualSell(' + "'" + id + "'" + ')" style="padding:4px 10px;background:#ff4466;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:0.8em;font-weight:bold;">SELL</button></div></div>';
                        });
                        document.getElementById('positionsList').innerHTML = posHtml;
                    } else { document.getElementById('positionsList').innerHTML = '<div class="no-positions">No active positions</div>'; }
                    const trades = t.tradeHistory || [];
                    const closedTrades = trades.filter(tr => tr.status === 'CLOSED');
                    const wins = closedTrades.filter(tr => (tr.pnl || 0) >= 0).length;
                    const losses = closedTrades.length - wins;
                    const winRate = closedTrades.length > 0 ? ((wins / closedTrades.length) * 100).toFixed(0) : '--';
                    document.getElementById('historyCount').textContent = closedTrades.length + ' trades | ' + winRate + '% win rate';
                    if (trades.length > 0) {
                        let histHtml = '';
                        trades.slice(-10).reverse().forEach(tr => {
                            const emoji = tr.status === 'OPEN' ? '‚è≥' : ((tr.pnl || 0) >= 0 ? '‚úÖ' : '‚ùå');
                            const pnlColor = (tr.pnl || 0) >= 0 ? '#00ff88' : '#ff4466';
                            let details = '';
                            if (tr.status === 'CLOSED') {
                                // üîÆ ENHANCED: Now shows $spent @ entry‚Üíexit +PnL
                                const spent = (tr.size || 0).toFixed(2);
                                details = '$' + spent + ' @ ' + ((tr.entry || 0) * 100).toFixed(0) + '¬¢‚Üí' + ((tr.exit || 0) * 100).toFixed(0) + '¬¢ ' + ((tr.pnl || 0) >= 0 ? '+' : '') + '$' + (tr.pnl || 0).toFixed(2);
                            } else {
                                details = 'Entry: ' + ((tr.entry || 0) * 100).toFixed(0) + '¬¢ | $' + (tr.size || 0).toFixed(2);
                            }
                            const modeEmoji = tr.mode === 'ORACLE' ? 'üîÆ' : tr.mode === 'SCALP' ? 'üéØ' : tr.mode === 'ARBITRAGE' ? 'üìä' : tr.mode === 'UNCERTAINTY' ? 'üåä' : tr.mode === 'MOMENTUM' ? 'üöÄ' : '‚ö°';
                            const modeColor = tr.mode === 'ORACLE' ? '#9933ff' : tr.mode === 'SCALP' ? '#ff6600' : tr.mode === 'ARBITRAGE' ? '#00ff88' : tr.mode === 'UNCERTAINTY' ? '#3399ff' : tr.mode === 'MOMENTUM' ? '#ff33cc' : '#ffaa00';
                            histHtml += '<div class="position-item"><span>' + emoji + ' <strong>' + (tr.asset || '?') + '</strong> ' + (tr.side || '?') + '</span><span style="color:' + modeColor + ';font-weight:bold;font-size:0.8em;background:rgba(0,0,0,0.3);padding:2px 5px;border-radius:3px;">' + modeEmoji + ' ' + (tr.mode || '?') + '</span><span style="color:' + pnlColor + ';font-size:0.85em;">' + details + '</span></div>';
                        });
                        document.getElementById('tradeHistory').innerHTML = histHtml;
                    } else { document.getElementById('tradeHistory').innerHTML = '<div class="no-positions">No trades yet</div>'; }
                }
            } catch (err) { console.error('updateUI error:', err); }
        }

        async function loadWallet() {
            try {
                const res = await fetch('/api/wallet');
                const data = await res.json();
                if (data.usdc?.success) {
                    document.getElementById('usdcBalance').textContent = '$' + data.usdc.balance.toFixed(2);
                    document.getElementById('liveBalance').textContent = '$' + data.usdc.balance.toFixed(2);
                }
                if (data.matic?.success) document.getElementById('maticBalance').textContent = data.matic.balance.toFixed(4);
                if (data.address) document.getElementById('depositAddress').textContent = data.address;
            } catch (e) { }
        }
        function copyAddress() { navigator.clipboard.writeText(document.getElementById('depositAddress').textContent).then(() => alert('Copied!')); }
        async function handleWithdraw() {
            const to = document.getElementById('withdrawTo').value.trim();
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const status = document.getElementById('withdrawStatus');
            if (!to || !amount) { status.textContent = '‚ùå Fill all fields'; status.className = 'status-msg error'; return; }
            if (!confirm('Send $' + amount + ' USDC to ' + to + '?')) return;
            try {
                const res = await fetch('/api/wallet/transfer', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ to, amount }) });
                const result = await res.json();
                if (result.success) { status.innerHTML = '‚úÖ Sent! <a href="' + result.explorerUrl + '" target="_blank" style="color:#00ff88;">View TX</a>'; status.className = 'status-msg success'; loadWallet(); }
                else { status.textContent = '‚ùå ' + result.error; status.className = 'status-msg error'; }
            } catch (e) { status.textContent = '‚ùå Network error'; status.className = 'status-msg error'; }
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                document.getElementById('paperBalance').value = data.PAPER_BALANCE || 1000;
                document.getElementById('maxPosition').value = (data.MAX_POSITION_SIZE || 0.1) * 100;
                if (data.ORACLE) {
                    document.getElementById('oracleEnabled').checked = data.ORACLE.enabled !== false;
                    document.getElementById('oracleConsensus').value = data.ORACLE.minConsensus || 0.85;
                    document.getElementById('oracleConfidence').value = data.ORACLE.minConfidence || 0.92;
                    document.getElementById('oracleEdge').value = data.ORACLE.minEdge || 15;
                    document.getElementById('oracleMaxOdds').value = data.ORACLE.maxOdds || 0.70;
                    // üîÆ ORACLE AGGRESSION
                    const aggression = data.ORACLE.aggression || 50;
                    document.getElementById('oracleAggression').value = aggression;
                    document.getElementById('aggressionValue').textContent = aggression + '%';
                }
                if (data.SCALP) { document.getElementById('scalpEnabled').checked = data.SCALP.enabled !== false; document.getElementById('scalpMaxEntry').value = (data.SCALP.maxEntryPrice || 0.20) * 100; document.getElementById('scalpTarget').value = data.SCALP.targetMultiple || 2.0; }
                if (data.ARBITRAGE) { document.getElementById('arbEnabled').checked = data.ARBITRAGE.enabled !== false; document.getElementById('arbMispricing').value = data.ARBITRAGE.minMispricing || 0.15; document.getElementById('arbTarget').value = data.ARBITRAGE.targetProfit || 0.50; document.getElementById('arbStopLoss').value = data.ARBITRAGE.stopLoss || 0.30; }
                // üåä UNCERTAINTY MODE
                if (data.UNCERTAINTY) {
                    document.getElementById('uncEnabled').checked = data.UNCERTAINTY.enabled !== false;
                    document.getElementById('uncThreshold').value = data.UNCERTAINTY.extremeThreshold || 0.80;
                    document.getElementById('uncTarget').value = data.UNCERTAINTY.targetReversion || 0.60;
                    document.getElementById('uncStopLoss').value = data.UNCERTAINTY.stopLoss || 0.25;
                }
                // üöÄ MOMENTUM MODE
                if (data.MOMENTUM) {
                    document.getElementById('momEnabled').checked = data.MOMENTUM.enabled !== false;
                    document.getElementById('momMinElapsed').value = data.MOMENTUM.minElapsed || 300;
                    document.getElementById('momConsensus').value = data.MOMENTUM.minConsensus || 0.75;
                    document.getElementById('momExitBefore').value = data.MOMENTUM.exitBeforeEnd || 180;
                }
                if (data.RISK) { document.getElementById('riskMaxExposure').value = (data.RISK.maxTotalExposure || 0.30) * 100; document.getElementById('riskStopLoss').value = (data.RISK.globalStopLoss || 0.20) * 100; document.getElementById('riskCooldown').value = data.RISK.cooldownAfterLoss || 300; }
            } catch (e) { console.error(e); }
        }
        function toggleModeConfig() { const p = document.getElementById('modeConfigPanel'); if (p) p.style.display = p.style.display === 'none' ? 'block' : 'none'; }
        async function applyPreset(preset) {
            const presets = {
                PINNACLE_V14: { ORACLE: { enabled: true, aggression: 50, minConsensus: 0.70, minConfidence: 0.70, minEdge: 10, maxOdds: 0.58, minStability: 3 }, SCALP: { enabled: false }, ARBITRAGE: { enabled: false }, MOMENTUM: { enabled: false }, UNCERTAINTY: { enabled: false }, RISK: { maxTotalExposure: 0.50, globalStopLoss: 0.40, cooldownAfterLoss: 1800, maxConsecutiveLosses: 3, maxGlobalTradesPerCycle: 2 } },
                CONSERVATIVE: { ORACLE: { enabled: true, minConsensus: 0.90, minConfidence: 0.92, minEdge: 20, maxOdds: 0.60 }, SCALP: { enabled: false }, ARBITRAGE: { enabled: false }, RISK: { maxTotalExposure: 0.20, globalStopLoss: 0.15, cooldownAfterLoss: 600 } },
                BALANCED: { ORACLE: { enabled: true, minConsensus: 0.85, minConfidence: 0.85, minEdge: 15, maxOdds: 0.70 }, SCALP: { enabled: true, maxEntryPrice: 0.20, targetMultiple: 2.0 }, ARBITRAGE: { enabled: true, minMispricing: 0.15, targetProfit: 0.50, stopLoss: 0.30 }, RISK: { maxTotalExposure: 0.30, globalStopLoss: 0.20, cooldownAfterLoss: 300 } },
                AGGRESSIVE: { ORACLE: { enabled: true, minConsensus: 0.75, minConfidence: 0.70, minEdge: 10, maxOdds: 0.80 }, SCALP: { enabled: true, maxEntryPrice: 0.30, targetMultiple: 1.5 }, ARBITRAGE: { enabled: true, minMispricing: 0.10, targetProfit: 0.30, stopLoss: 0.40 }, RISK: { maxTotalExposure: 0.50, globalStopLoss: 0.30, cooldownAfterLoss: 120 } }
            };
            const p = presets[preset];
            if (!p) return;
            try {
                await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(p) });
                loadSettings();
                const status = document.getElementById('settingsStatus');
                status.textContent = '‚úÖ ' + preset + ' preset applied!';
                status.className = 'status-msg success';
            } catch (e) { console.error(e); }
        }
        async function setMode(mode) {
            if (mode === 'LIVE' && !confirm('WARNING: LIVE MODE - Real orders, real USDC, real losses! Continue?')) return;
            try {
                await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ TRADE_MODE: mode }) });
                fetchData();
                const status = document.getElementById('settingsStatus');
                status.textContent = mode === 'LIVE' ? 'LIVE MODE ENABLED' : 'Paper mode enabled';
                status.className = 'status-msg ' + (mode === 'LIVE' ? 'error' : 'success');
            } catch (e) { }
        }
        async function saveAllSettings() {
            const updates = {
                PAPER_BALANCE: parseFloat(document.getElementById('paperBalance').value),
                MAX_POSITION_SIZE: parseFloat(document.getElementById('maxPosition').value) / 100,
                ORACLE: {
                    enabled: document.getElementById('oracleEnabled').checked,
                    aggression: parseInt(document.getElementById('oracleAggression').value),
                    minConsensus: parseFloat(document.getElementById('oracleConsensus').value),
                    minConfidence: parseFloat(document.getElementById('oracleConfidence').value),
                    minEdge: parseFloat(document.getElementById('oracleEdge').value),
                    maxOdds: parseFloat(document.getElementById('oracleMaxOdds').value),
                    requireTrending: false,
                    requireMomentum: false,
                    minStability: 3
                },
                SCALP: { enabled: document.getElementById('scalpEnabled').checked, maxEntryPrice: parseFloat(document.getElementById('scalpMaxEntry').value) / 100, targetMultiple: parseFloat(document.getElementById('scalpTarget').value), requireLean: true, exitBeforeEnd: 120 },
                ARBITRAGE: { enabled: document.getElementById('arbEnabled').checked, minMispricing: parseFloat(document.getElementById('arbMispricing').value), targetProfit: parseFloat(document.getElementById('arbTarget').value), stopLoss: parseFloat(document.getElementById('arbStopLoss').value), maxHoldTime: 600 },
                UNCERTAINTY: {
                    enabled: document.getElementById('uncEnabled').checked,
                    extremeThreshold: parseFloat(document.getElementById('uncThreshold').value),
                    targetReversion: parseFloat(document.getElementById('uncTarget').value),
                    stopLoss: parseFloat(document.getElementById('uncStopLoss').value),
                    volatilityMin: 0.02
                },
                MOMENTUM: {
                    enabled: document.getElementById('momEnabled').checked,
                    minElapsed: parseInt(document.getElementById('momMinElapsed').value),
                    minConsensus: parseFloat(document.getElementById('momConsensus').value),
                    exitBeforeEnd: parseInt(document.getElementById('momExitBefore').value),
                    breakoutThreshold: 0.03,
                    exitOnReversal: true
                },
                RISK: { maxTotalExposure: parseFloat(document.getElementById('riskMaxExposure').value) / 100, globalStopLoss: parseFloat(document.getElementById('riskStopLoss').value) / 100, cooldownAfterLoss: parseInt(document.getElementById('riskCooldown').value) }
            };
            const apiKey = document.getElementById('apiKey').value;
            const apiSecret = document.getElementById('apiSecret').value;
            const apiPassphrase = document.getElementById('apiPassphrase').value;
            const privateKey = document.getElementById('privateKey').value;
            if (apiKey) updates.POLYMARKET_API_KEY = apiKey;
            if (apiSecret) updates.POLYMARKET_SECRET = apiSecret;
            if (apiPassphrase) updates.POLYMARKET_PASSPHRASE = apiPassphrase;
            if (privateKey) updates.POLYMARKET_PRIVATE_KEY = privateKey;
            try {
                await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updates) });
                document.getElementById('settingsStatus').textContent = '‚úÖ All settings saved!';
                document.getElementById('settingsStatus').className = 'status-msg success';
                fetchData();
            } catch (e) { document.getElementById('settingsStatus').textContent = '‚ùå Error saving'; document.getElementById('settingsStatus').className = 'status-msg error'; }
        }
        async function resetPaperBalance() {
            if (!confirm('Reset paper balance? This will close all positions and reset P/L.')) return;
            try {
                const newBalance = parseFloat(document.getElementById('paperBalance').value);
                await fetch('/api/reset-balance', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ balance: newBalance }) });
                document.getElementById('settingsStatus').textContent = '‚úÖ Paper balance reset to $' + newBalance;
                document.getElementById('settingsStatus').className = 'status-msg success';
                fetchData();
            } catch (e) { document.getElementById('settingsStatus').textContent = '‚ùå Reset failed'; document.getElementById('settingsStatus').className = 'status-msg error'; }
        }

        // MANUAL TRADING FUNCTIONS
        async function manualBuy(asset, direction) {
            const size = prompt('Enter trade size in $ (e.g. 10):', '10');
            if (!size) return;
            const sizeNum = parseFloat(size);
            if (isNaN(sizeNum) || sizeNum < 1) {
                alert('Size must be at least $1');
                return;
            }

            const mode = currentData?._trading?.mode || 'PAPER';
            if (mode === 'LIVE' && !confirm('‚ö†Ô∏è LIVE MODE: This will place a REAL order with $' + sizeNum.toFixed(2) + '. Continue?')) {
                return;
            }

            try {
                const res = await fetch('/api/manual-buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asset, direction, size: sizeNum })
                });
                const result = await res.json();
                if (result.success) {
                    alert('‚úÖ Buy order placed: ' + asset + ' ' + direction + ' @ ' + (result.entryPrice * 100).toFixed(1) + '¬¢');
                    fetchData();
                } else {
                    alert('‚ùå Buy failed: ' + result.error);
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function manualSell(positionId) {
            const mode = currentData?._trading?.mode || 'PAPER';
            const pos = currentData?._trading?.positions?.[positionId];

            if (mode === 'LIVE' && !confirm('‚ö†Ô∏è LIVE MODE: This will SELL your ' + (pos?.asset || 'unknown') + ' position. Continue?')) {
                return;
            }

            try {
                const res = await fetch('/api/manual-sell', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positionId })
                });
                const result = await res.json();
                if (result.success) {
                    alert('‚úÖ Sell order executed' + (result.paper ? ' (paper)' : ''));
                    fetchData();
                } else {
                    alert('‚ùå Sell failed: ' + result.error + (result.needsManualIntervention ? '\n\nCheck /api/pending-sells for stuck positions.' : ''));
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        // PENDING SELLS / RECOVERY FUNCTIONS
        async function loadPendingSells() {
            try {
                const res = await fetch('/api/pending-sells');
                const data = await res.json();
                const container = document.getElementById('pendingSellsList');

                if (!data.pendingSells || Object.keys(data.pendingSells).length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:30px;color:#00ff88;"><span style="font-size:2em;">‚úÖ</span><br><br>No pending sells! All positions sold successfully.</div>';
                    return;
                }

                let html = '<div style="color:#888;font-size:0.85em;margin-bottom:10px;">Found <strong style="color:#ff9900;">' + data.count + '</strong> pending sell(s)</div>';

                for (const [key, ps] of Object.entries(data.pendingSells)) {
                    const failTime = new Date(ps.failedAt).toLocaleString();
                    html += '<div style="background:rgba(255,0,0,0.1);border:1px solid #ff4466;border-radius:8px;padding:15px;margin-bottom:12px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">';
                    html += '<span style="font-weight:bold;color:#ff4466;font-size:1.1em;">‚ùå ' + (ps.asset || 'Unknown') + ' - ' + (ps.side || '?') + '</span>';
                    html += '<span style="color:#888;font-size:0.8em;">Failed: ' + failTime + '</span>';
                    html += '</div>';
                    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.85em;">';
                    html += '<div><span style="color:#888;">Size:</span> <strong>$' + (ps.size || 0).toFixed(2) + '</strong></div>';
                    html += '<div><span style="color:#888;">Entry:</span> <strong>' + ((ps.entry || 0) * 100).toFixed(1) + '¬¢</strong></div>';
                    html += '<div><span style="color:#888;">Token ID:</span> <code style="font-size:0.75em;background:rgba(0,0,0,0.3);padding:2px 5px;border-radius:3px;">' + (ps.tokenId ? ps.tokenId.substring(0, 20) + '...' : 'N/A') + '</code></div>';
                    html += '<div><span style="color:#888;">Condition ID:</span> <code style="font-size:0.75em;background:rgba(0,0,0,0.3);padding:2px 5px;border-radius:3px;">' + (ps.conditionId ? ps.conditionId.substring(0, 20) + '...' : 'N/A') + '</code></div>';
                    html += '</div>';
                    html += '<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">';
                    if (ps.marketUrl) html += '<a href="' + ps.marketUrl + '" target="_blank" style="padding:6px 12px;background:#4fc3f7;color:#000;border-radius:5px;text-decoration:none;font-size:0.8em;font-weight:bold;">üìä View Market</a>';
                    if (ps.polygonscanUrl) html += '<a href="' + ps.polygonscanUrl + '" target="_blank" style="padding:6px 12px;background:#8b5cf6;color:#fff;border-radius:5px;text-decoration:none;font-size:0.8em;font-weight:bold;">üîç PolygonScan</a>';
                    html += '<button onclick="retrySell(' + "'" + key + "'" + ')" style="padding:6px 12px;background:#ff6600;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:0.8em;font-weight:bold;">üîÑ Retry Sell</button>';
                    html += '</div>';
                    if (ps.redemptionInstructions) {
                        html += '<details style="margin-top:10px;"><summary style="color:#ffd700;cursor:pointer;font-size:0.85em;">üìñ Manual Recovery Instructions</summary>';
                        html += '<div style="margin-top:8px;padding:10px;background:rgba(0,0,0,0.3);border-radius:6px;font-size:0.8em;color:#aaa;white-space:pre-wrap;">' + ps.redemptionInstructions + '</div>';
                        html += '</details>';
                    }
                    html += '</div>';
                }

                container.innerHTML = html;
            } catch (e) {
                document.getElementById('pendingSellsList').innerHTML = '<div style="text-align:center;padding:20px;color:#ff4466;">‚ùå Error loading: ' + e.message + '</div>';
            }
        }

        async function retrySell(key) {
            const [asset, tokenId] = key.split('_');
            if (!confirm('Retry selling ' + asset + ' position?')) return;
            try {
                const res = await fetch('/api/retry-sell', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asset, tokenId })
                });
                const result = await res.json();
                if (result.success) {
                    alert('‚úÖ Sell successful!');
                    loadPendingSells();
                } else {
                    alert('‚ùå Retry failed: ' + result.error);
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        fetchData(); loadWallet(); loadSettings();
        setInterval(fetchData, 1000);
        setInterval(loadWallet, 30000);
        setInterval(loadPendingSells, 10000); // Auto-refresh pending sells every 10s
    </script>
</body>

</html>